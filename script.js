// Complete Student Data - All 72 Students
const COMPLETE_DATA = {
  "4 Pearl": {
    "Pre-A1": {
      "üêØ The Mighty Tigers": {
        totalPoints: 245,
        members: [
          { name: "ADELLA KAISARA BINTI AMDAN", points: 45 },
          { name: "AHMAD JIHAD BIN ABDULLAH", points: 50 },
          { name: "ANJENNY PAILEE", points: 40 },
          { name: "AZIZAH ALISHA BINTI AZMIZAN AZRIN", points: 55 },
          { name: "AZIB ARYAN BIN A.RAHMAN", points: 55 }
        ]
      },
      "üêº The Brave Bears": {
        totalPoints: 210,
        members: [
          { name: "GIDEON GALE GARRY", points: 40 },
          { name: "FAREL BIN ARSID", points: 45 },
          { name: "INDRA PUTRA BIN JAINI", points: 35 },
          { name: "MOHAMMAD ABDUL KHALIQ BIN NAISAR", points: 45 },
          { name: "MOHAMAD NUR ZAQIF ZIQRI BIN MOHAMAD TINO", points: 45 }
        ]
      },
      "üê∞ The Swift Rabbits": {
        totalPoints: 230,
        members: [
          { name: "MUHAMMAD DANISH IFWAT BIN MUHAMMAD IFFAD", points: 50 },
          { name: "MOHAMAD AL HAKIM BIN MOHAMAD RAJAN", points: 45 },
          { name: "MOHAMAD RAID RUZAIMIE BIN MOHD SALIHAN", points: 40 },
          { name: "NUR AIN HAWA SYAKIELA BINTI ILHAM SUKRI", points: 45 },
          { name: "MUHAMMAD IRMANSYAH BIN ABDUL BASIR", points: 50 }
        ]
      }
    },
    "Low A1": {
      "ü¶ä The Clever Foxes": {
        totalPoints: 275,
        members: [
          { name: "MUHAMMAD YUSUF BIN ANNUAR", points: 55 },
          { name: "NOR ZAMIRAH QALISYAH BINTI MOHD ZAMIRUL", points: 60 },
          { name: "MUHAMMAD RAYYAN BIN ARNER", points: 50 },
          { name: "MUHAMMAD AKIF QAIYYUM BIN RANO", points: 55 },
          { name: "MUHAMMAD ASNAWI BIN HAMZAH", points: 55 }
        ]
      }
    },
    "Mid A1": {
      "ü¶Ö The Brave Eagles": {
        totalPoints: 285,
        members: [
          { name: "NOOR QASEH NADIA BINTI ABDULLAH", points: 60 },
          { name: "MIESYA NUR SYAZIERRA BINTI ISA", points: 55 },
          { name: "MOHAMAD WAN MARZUQI BIN MAZLAN", points: 55 },
          { name: "NOR FATIYYAH FARAHANIE BINTI ZAINI", points: 60 },
          { name: "MUHAMMAD NAZRIN BIN ZULLASRI", points: 55 }
        ]
      },
      "üêÜ The Swift Panthers": {
        totalPoints: 270,
        members: [
          { name: "MUHAMMAD AL FATIH BIN MOHAMAD FAIZAL AFINDI", points: 55 },
          { name: "NUBHAN BIN JAMIL", points: 50 },
          { name: "NURUL FARAH KHALISYAH BINTI PABIL", points: 55 },
          { name: "NURUL ALISA SAPPIKA BINTI ABDULLAH", points: 55 },
          { name: "MUHAMMAD FAIS BIN HENRAL", points: 55 }
        ]
      }
    },
    "High A1": {
      "ü¶ã The Shining Butterflies": {
        totalPoints: 330,
        members: [
          { name: "PUTRI ARIESA ZULAIKHA BINTI JUISAL", points: 60 },
          { name: "PUTERI MYA ARLISSA BINTI MOHD BAKRI", points: 55 },
          { name: "MUHAMMAD IRFAN BIN UDAYKUMAR CHOCKALINGAM SHANMUGAM", points: 55 },
          { name: "MUHAMMAD IKMAL BIN RIDSMAR", points: 50 },
          { name: "SYARIF ABDUL HALIM BIN ALNASIR", points: 55 },
          { name: "SITI NUR PUTRI BALQISHAH BINTI MOHD ZALANI", points: 55 }
        ]
      }
    }
  },
  "4 Crystal": {
    "Pre-A1": {
      "üêí The Playful Monkeys": {
        totalPoints: 405,
        members: [
          { name: "ASHIRAH BINTI ASIS", points: 45 },
          { name: "AIDIL FAZLI BIN ABDULLAH", points: 45 },
          { name: "AL SYAMIR BIN ABDUL NASIR", points: 45 },
          { name: "ELYANA BINTI MARTIN", points: 45 },
          { name: "HAFIZAM AKIM BIN ABDUL AZIS", points: 45 },
          { name: "HAIJAL BIN JAINAL", points: 45 },
          { name: "IMANINA HUSNA BINTI MUHAMMAD SALI", points: 45 },
          { name: "MOHAMMAD HAIKAL HAKIMI BIN ABDULLAH", points: 45 },
          { name: "MOHAMMAD AIREIL DANNISH BIN ASYRAT", points: 45 }
        ]
      },
      "ü¶â The Wise Owls": {
        totalPoints: 360,
        members: [
          { name: "MOHAMED DANIEL IMAN BIN BOHARI", points: 45 },
          { name: "MOHAMAD RAIDI SAHRIMAL BIN JAMRI", points: 45 },
          { name: "MUHAMAD AZRUL BIN AZLAN", points: 45 },
          { name: "MUHAMMAD NOOR FAZRIE BIN AMRAN", points: 45 },
          { name: "NUR ARYSA QAISARA BINTI MASRI", points: 45 },
          { name: "NAEL BIN MOHD NIJAR", points: 45 },
          { name: "NIRWANSA BIN RANO", points: 45 },
          { name: "NORAINA BINTI ABDULLAH", points: 45 }
        ]
      },
      "üê∫ The Fearless Wolves": {
        totalPoints: 360,
        members: [
          { name: "NUR PATIAH BINTI ABDULLAH", points: 45 },
          { name: "NUR KHATIJA BINTI IBRAHIM", points: 45 },
          { name: "NURUL HUMAIRA BINTI ASANAL", points: 45 },
          { name: "NAISHA BINTI AZMAN", points: 45 },
          { name: "NUR AFFINA AULIA BINTI RIZAL", points: 45 },
          { name: "MUHAMMAD DANNY ASHRAF BIN ABDULLAH", points: 45 },
          { name: "MUHAMMAD AADAM KHALIF BIN MUHAMMAD HAIRUL NIZAM", points: 45 },
          { name: "NURAISYAH NATASYA BINTI MOHD HANIF WASNI", points: 45 }
        ]
      },
      "ü¶Å The Glorious Lions": {
        totalPoints: 495,
        members: [
          { name: "NURAZLIYANAH BATRISHA BINTI SABRI", points: 45 },
          { name: "MOHAMAD RIZANI SYAHIZIEY BIN ABDULLAH", points: 45 },
          { name: "MUHAMMAD HAIZUL BIN OMAR", points: 45 },
          { name: "MUHAMMAD QAWIEM RAFIQ BIN RAZLAN", points: 45 },
          { name: "NUR AZMINA BINTI ABDULLAH", points: 45 },
          { name: "MOHAMMAD SHAZWAN BIN NAZMI", points: 45 },
          { name: "NURUL ALYA ZULAIKHA BINTI SINAKASONI", points: 45 },
          { name: "NURLUTHFIA AZZAHRA BINTI JUWAWI", points: 45 },
          { name: "SITI UMAIRAH BINTI IBRAHIM", points: 45 },
          { name: "WHIRYAN SHAH BIN MOHD NORHISMAL", points: 45 },
          { name: "MUHAMMAD HAFIZ UQASYAH BIN ABDULLAH", points: 45 }
        ]
      }
    }
  }
};

class JungleRewardsSystem {
    constructor() {
        this.currentClass = '4 Pearl';
        this.currentView = 'visitor';
        this.isAuthenticated = false;
        this.storageKey = 'jungleRewardsData';
        
        this.initializeApp();
    }

    initializeApp() {
        console.log('üöÄ Initializing Jungle Rewards System...');
        
        // Initialize or load data
        this.initializeData();
        
        // Check for existing authentication
        const savedAuth = localStorage.getItem('jungleAuthenticated');
        if (savedAuth === 'true') {
            this.isAuthenticated = true;
            this.toggleAuthState(true);
        }

        this.loadInitialData();
        this.setupEventListeners();
        this.hideLoadingScreen();
        
        this.showToast('Welcome to Jungle Rewards!', 'success');
    }

    initializeData() {
        let storedData = localStorage.getItem(this.storageKey);
        
        if (!storedData) {
            // First time - initialize with complete data
            localStorage.setItem(this.storageKey, JSON.stringify(COMPLETE_DATA));
            this.showToast('System initialized with all student data', 'success');
        }
    }

    getData() {
        const storedData = localStorage.getItem(this.storageKey);
        return storedData ? JSON.parse(storedData) : COMPLETE_DATA;
    }

    saveData(data) {
        localStorage.setItem(this.storageKey, JSON.stringify(data));
    }

    loadInitialData() {
        console.log('üìä Loading complete data...');
        const data = this.getData();
        this.updateGroupsDisplay(data);
        this.updateLastUpdated();
        this.updateSystemStats(data);
        this.showToast(`Loaded ${this.currentClass} data`, 'success');
    }

    updateGroupsDisplay(groupsData) {
        const groupsGrid = document.getElementById('groupsGrid');
        
        if (!groupsGrid) {
            console.error('Groups grid element not found');
            return;
        }

        let html = '';
        let totalGroups = 0;

        for (const [className, levels] of Object.entries(groupsData)) {
            if (className !== this.currentClass) continue;
            
            for (const [level, groups] of Object.entries(levels)) {
                for (const [groupName, groupData] of Object.entries(groups)) {
                    totalGroups++;
                    
                    const groupPoints = groupData.totalPoints || 0;
                    const memberCount = groupData.members ? groupData.members.length : 0;
                    
                    html += `
                        <div class="group-card" data-class="${className}" data-group="${groupName}">
                            <div class="group-header">
                                <div class="group-name">${groupName}</div>
                                <div class="group-level">
                                    <i class="fas fa-layer-group"></i>
                                    ${level} ‚Ä¢ ${className}
                                </div>
                            </div>
                            
                            <div class="group-stats">
                                <div class="points-display">
                                    <div class="points-icon">
                                        <i class="fas fa-gem"></i>
                                    </div>
                                    <div class="points-info">
                                        <div class="points-value">${groupPoints}</div>
                                        <div class="points-label">Crystals</div>
                                    </div>
                                </div>
                                <div class="member-count">
                                    <i class="fas fa-users"></i>
                                    ${memberCount} members
                                </div>
                            </div>
                            
                            <div class="group-actions">
                                <button class="group-action-btn view-members" 
                                        onclick="app.showGroupMembers('${className}', '${groupName}', '${level}')">
                                    <i class="fas fa-list"></i>
                                    View Members
                                </button>
                                ${this.isAuthenticated ? `
                                <button class="group-action-btn group-bonus" 
                                        onclick="app.applyGroupBonus('${groupName}', '${className}')">
                                    <i class="fas fa-star"></i>
                                    +10 Bonus
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }
        }

        groupsGrid.innerHTML = html;
        console.log(`‚úÖ Displayed ${totalGroups} groups for ${this.currentClass}`);
    }

    showGroupMembers(className, groupName, level) {
        const data = this.getData();
        const groupData = data[className]?.[level]?.[groupName];
        
        if (!groupData) {
            this.showToast('Group data not found', 'error');
            return;
        }

        this.showGroupModal(className, groupName, level, groupData.members);
    }

    showGroupModal(className, groupName, level, students) {
        // Create modal HTML
        const modalHTML = `
            <div class="modal" id="groupModal">
                <div class="modal-content premium-modal">
                    <div class="modal-header">
                        <h3><i class="fas fa-users"></i> ${groupName}</h3>
                        <button class="close-modal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="group-modal-header">
                            <div class="group-info">
                                <div class="group-class">${className}</div>
                                <div class="group-level">${level}</div>
                            </div>
                            <div class="group-stats-summary">
                                <div class="stat">
                                    <i class="fas fa-users"></i>
                                    <span>${students.length} Members</span>
                                </div>
                                <div class="stat">
                                    <i class="fas fa-gem"></i>
                                    <span>${students.reduce((sum, student) => sum + (student.points || 0), 0)} Total Crystals</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="members-list">
                            <h4>Group Members</h4>
                            ${students.map((student, index) => `
                                <div class="member-item ${this.isAuthenticated ? 'editable' : ''}">
                                    <div class="member-info">
                                        <div class="member-rank">${index + 1}</div>
                                        <div class="member-details">
                                            <div class="member-name">${student.name}</div>
                                            <div class="member-points">${student.points} crystals</div>
                                        </div>
                                    </div>
                                    ${this.isAuthenticated ? `
                                    <div class="member-actions">
                                        <button class="point-btn add-point" onclick="app.updateStudentPoints('${student.name.replace(/'/g, "\\'")}', 1)" title="Add 1 point">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <button class="point-btn remove-point" onclick="app.updateStudentPoints('${student.name.replace(/'/g, "\\'")}', -1)" title="Remove 1 point">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <button class="point-btn bonus-point" onclick="app.updateStudentPoints('${student.name.replace(/'/g, "\\'")}', 5)" title="Add 5 points">
                                            <i class="fas fa-star"></i>
                                        </button>
                                    </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add modal to document
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Show modal
        const modal = document.getElementById('groupModal');
        modal.classList.remove('hidden');
        
        // Add event listeners
        modal.querySelector('.close-modal').addEventListener('click', () => {
            modal.remove();
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    updateStudentPoints(studentName, pointsChange) {
        if (!this.isAuthenticated) {
            this.showToast('Please login as teacher first', 'warning');
            return;
        }

        const data = this.getData();
        let studentFound = false;

        // Find and update the student's points
        for (const [className, levels] of Object.entries(data)) {
            for (const [level, groups] of Object.entries(levels)) {
                for (const [groupName, groupData] of Object.entries(groups)) {
                    const studentIndex = groupData.members.findIndex(s => s.name === studentName);
                    if (studentIndex !== -1) {
                        studentFound = true;
                        const student = groupData.members[studentIndex];
                        const newPoints = Math.max(0, student.points + pointsChange);
                        
                        // Update student points
                        student.points = newPoints;
                        
                        // Update group total
                        groupData.totalPoints = groupData.members.reduce((sum, s) => sum + s.points, 0);
                        
                        // Save updated data
                        this.saveData(data);
                        
                        // Reload display
                        this.loadInitialData();
                        
                        const action = pointsChange >= 0 ? 'added' : 'deducted';
                        const emoji = pointsChange >= 0 ? '‚ú®' : '‚ö†Ô∏è';
                        this.showToast(`${emoji} ${Math.abs(pointsChange)} points ${action} for ${studentName}`, 'success');
                        
                        // Close modal if open
                        const modal = document.getElementById('groupModal');
                        if (modal) modal.remove();
                        
                        return;
                    }
                }
            }
        }

        if (!studentFound) {
            this.showToast('Student not found', 'error');
        }
    }

    applyGroupBonus(groupName, className) {
        if (!this.isAuthenticated) {
            this.showToast('Please login as teacher first', 'warning');
            return;
        }

        const data = this.getData();
        const groupData = data[className];

        if (!groupData) {
            this.showToast('Class not found', 'error');
            return;
        }

        let groupFound = false;
        let levelName = '';

        // Find the group and apply bonus
        for (const [level, groups] of Object.entries(groupData)) {
            if (groups[groupName]) {
                groupFound = true;
                levelName = level;
                const group = groups[groupName];
                
                // Add 10 points to each member
                group.members.forEach(student => {
                    student.points += 10;
                });
                
                // Update group total
                group.totalPoints = group.members.reduce((sum, s) => sum + s.points, 0);
                
                // Save updated data
                this.saveData(data);
                
                // Reload display
                this.loadInitialData();
                
                this.showToast(`üéâ +10 points bonus applied to ${groupName}`, 'success');
                break;
            }
        }

        if (!groupFound) {
            this.showToast('Group not found', 'error');
        }
    }

    resetAllPoints() {
        if (!this.isAuthenticated) {
            this.showToast('Please login as teacher first', 'warning');
            return;
        }

        if (!confirm('‚ö†Ô∏è Are you sure you want to reset ALL points to zero?\n\nThis action cannot be undone!')) {
            return;
        }

        const data = this.getData();
        
        // Reset all points to 0
        for (const [className, levels] of Object.entries(data)) {
            for (const [level, groups] of Object.entries(levels)) {
                for (const [groupName, groupData] of Object.entries(groups)) {
                    groupData.members.forEach(student => {
                        student.points = 0;
                    });
                    groupData.totalPoints = 0;
                }
            }
        }
        
        // Save reset data
        this.saveData(data);
        
        // Reload display
        this.loadInitialData();
        
        this.showToast('‚úÖ All points have been reset to zero', 'success');
    }

    initializeSystemData() {
        if (!this.isAuthenticated) {
            this.showToast('Please login as teacher first', 'warning');
            return;
        }

        if (!confirm('üîÑ Initialize system data?\n\nThis will reset all students and points to initial state.')) {
            return;
        }

        // Reset to original complete data
        localStorage.removeItem(this.storageKey);
        this.initializeData();
        this.loadInitialData();
        
        this.showToast('‚úÖ System reinitialized with original data', 'success');
    }

    updateLastUpdated() {
        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (lastUpdatedElement) {
            const now = new Date();
            lastUpdatedElement.textContent = `Updated: ${now.toLocaleTimeString()}`;
        }
    }

    updateSystemStats(data) {
        const systemStats = document.getElementById('systemStats');
        if (!systemStats) return;

        let totalStudents = 0;
        let totalCrystals = 0;
        let totalGroups = 0;

        for (const [className, levels] of Object.entries(data)) {
            for (const [level, groups] of Object.entries(levels)) {
                for (const [groupName, groupData] of Object.entries(groups)) {
                    totalGroups++;
                    totalStudents += groupData.members.length;
                    totalCrystals += groupData.totalPoints;
                }
            }
        }

        systemStats.innerHTML = `
            <div class="stat-item">
                <i class="fas fa-users"></i>
                <span>Total Students: ${totalStudents}</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-gem"></i>
                <span>Total Crystals: ${totalCrystals}</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-layer-group"></i>
                <span>Active Groups: ${totalGroups}</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-clock"></i>
                <span>Last Updated: ${new Date().toLocaleTimeString()}</span>
            </div>
        `;
    }

    toggleAuthState(isAuthenticated) {
        const appContainer = document.getElementById('app');
        if (appContainer) {
            if (isAuthenticated) {
                appContainer.classList.add('authenticated');
                this.showToast('Teacher mode activated', 'success');
            } else {
                appContainer.classList.remove('authenticated');
            }
        }
    }

    switchView(view) {
        this.currentView = view;
        const viewButtons = document.querySelectorAll('.view-btn');
        
        viewButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.view === view) {
                btn.classList.add('active');
            }
        });

        if (view === 'teacher' && !this.isAuthenticated) {
            this.showModal('loginModal');
        } else {
            this.showToast(`Switched to ${view} view`, 'info');
        }
    }

    switchClass(className) {
        this.currentClass = className;
        const classDisplay = document.getElementById('currentClassDisplay');
        if (classDisplay) {
            classDisplay.innerHTML = `<i class="fas fa-graduation-cap"></i> ${className}`;
        }
        
        this.loadInitialData();
    }

    showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }

    showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas fa-${this.getToastIcon(type)}"></i>
            </div>
            <div class="toast-message">${message}</div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;

        container.appendChild(toast);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    getToastIcon(type) {
        const icons = {
            success: 'check-circle',
            error: 'exclamation-triangle',
            warning: 'exclamation-circle',
            info: 'info-circle'
        };
        return icons[type] || 'info-circle';
    }

    hideLoadingScreen() {
        const loadingScreen = document.getElementById('loadingScreen');
        const appContainer = document.getElementById('app');
        
        if (loadingScreen && appContainer) {
            loadingScreen.style.opacity = '0';
            loadingScreen.style.pointerEvents = 'none';
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                appContainer.classList.remove('hidden');
                
                setTimeout(() => {
                    appContainer.style.opacity = '1';
                }, 50);
            }, 500);
        }
    }

    verifyAdminPassword(password) {
        if (password === 'jungle123') {
            this.isAuthenticated = true;
            localStorage.setItem('jungleAuthenticated', 'true');
            this.toggleAuthState(true);
            this.showToast('Admin access granted!', 'success');
            this.hideModal('loginModal');
            return true;
        } else {
            this.showToast('Invalid password', 'error');
            return false;
        }
    }

    logout() {
        this.isAuthenticated = false;
        localStorage.removeItem('jungleAuthenticated');
        this.toggleAuthState(false);
        this.showToast('Logged out successfully', 'info');
    }

    setupEventListeners() {
        console.log('üîß Setting up event listeners...');
        
        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.currentTarget.dataset.page;
                this.switchPage(page);
            });
        });

        // Class selector
        const classSelector = document.getElementById('classSelector');
        if (classSelector) {
            classSelector.value = this.currentClass;
            classSelector.addEventListener('change', (e) => {
                this.switchClass(e.target.value);
            });
        }

        // Leaderboard class selector
        const leaderboardClassSelector = document.getElementById('leaderboardClassSelector');
        if (leaderboardClassSelector) {
            leaderboardClassSelector.addEventListener('change', (e) => {
                this.loadLeaderboardData(e.target.value);
            });
        }

        // View toggle
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.switchView(e.currentTarget.dataset.view);
            });
        });

        // Tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tab = e.currentTarget.dataset.tab;
                this.switchTab(tab);
            });
        });

        // Login button
        const loginBtn = document.getElementById('loginBtn');
        if (loginBtn) {
            loginBtn.addEventListener('click', () => {
                this.showModal('loginModal');
            });
        }

        // Logout button
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                this.logout();
            });
        }

        // Login form submission
        const submitLogin = document.getElementById('submitLogin');
        const adminPassword = document.getElementById('adminPassword');
        
        if (submitLogin && adminPassword) {
            submitLogin.addEventListener('click', () => {
                const password = adminPassword.value.trim();
                if (password) {
                    this.verifyAdminPassword(password);
                } else {
                    this.showToast('Please enter password', 'warning');
                }
            });

            adminPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitLogin.click();
                }
            });
        }

        // Refresh button
        const refreshBtn = document.getElementById('refreshData');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                this.loadInitialData();
            });
        }

        // Admin buttons
        const resetBtn = document.getElementById('resetAllPoints');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                this.resetAllPoints();
            });
        }

        const initBtn = document.getElementById('initializeData');
        if (initBtn) {
            initBtn.addEventListener('click', () => {
                this.initializeSystemData();
            });
        }

        const exportBtn = document.getElementById('exportData');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                this.exportData();
            });
        }

        // Modal close buttons
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                if (modal) {
                    this.hideModal(modal.id);
                }
            });
        });

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    this.hideModal(modal.id);
                }
            });
        });

        // Escape key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.hideModal('loginModal');
                const groupModal = document.getElementById('groupModal');
                if (groupModal) groupModal.remove();
            }
        });

        // Home page CTA buttons
        document.querySelectorAll('[data-page]').forEach(btn => {
            if (btn.closest('.hero-actions')) {
                btn.addEventListener('click', (e) => {
                    const page = e.currentTarget.dataset.page;
                    this.switchPage(page);
                });
            }
        });

        console.log('‚úÖ Event listeners setup complete');
    }

    switchPage(page) {
        // Hide all pages
        document.querySelectorAll('.page').forEach(p => {
            p.classList.remove('active');
        });

        // Show target page
        const targetPage = document.getElementById(`${page}Page`);
        if (targetPage) {
            targetPage.classList.add('active');
        }

        // Update navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.dataset.page === page) {
                link.classList.add('active');
            }
        });

        // Load page-specific data
        if (page === 'dashboard') {
            this.loadInitialData();
        } else if (page === 'leaderboard') {
            this.loadLeaderboardData();
        }

        this.showToast(`Navigated to ${page.charAt(0).toUpperCase() + page.slice(1)}`, 'info');
    }

    loadLeaderboardData(classFilter = 'all') {
        const groupsContent = document.getElementById('groupsLeaderboardContent');
        if (!groupsContent) return;

        const data = this.getData();
        let groupsList = [];

        for (const [className, levels] of Object.entries(data)) {
            if (classFilter !== 'all' && className !== classFilter) continue;
            
            for (const [level, groups] of Object.entries(levels)) {
                for (const [groupName, groupData] of Object.entries(groups)) {
                    groupsList.push({
                        name: groupName,
                        class: className,
                        level: level,
                        points: groupData.totalPoints || 0,
                        members: groupData.members ? groupData.members.length : 0
                    });
                }
            }
        }

        // Sort by points
        groupsList.sort((a, b) => b.points - a.points);

        let groupsHtml = '';
        groupsList.forEach((group, index) => {
            const rankClass = index < 3 ? `rank-${index + 1}` : '';
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
            
            groupsHtml += `
                <div class="leaderboard-item">
                    <div class="rank ${rankClass}">${medal} ${index + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">
                            ${group.name}
                            <span class="group-badge">${group.class}</span>
                        </div>
                        <div class="leaderboard-meta">
                            ${group.level} ‚Ä¢ ${group.members} members
                        </div>
                    </div>
                    <div class="leaderboard-points">${group.points}</div>
                </div>
            `;
        });

        groupsContent.innerHTML = groupsHtml;
    }

    switchTab(tab) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tab === tab) {
                btn.classList.add('active');
            }
        });

        // Update tab content
        document.querySelectorAll('.leaderboard-tab').forEach(tabElement => {
            tabElement.classList.remove('active');
            if (tabElement.id === `${tab}Leaderboard`) {
                tabElement.classList.add('active');
            }
        });
    }

    exportData() {
        const data = this.getData();
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'jungle-rewards-data.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        this.showToast('Data exported successfully', 'success');
    }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    console.log('üåø DOM loaded - initializing Jungle Rewards System');
    window.app = new JungleRewardsSystem();
});

// Add utility functions to global scope
window.switchPage = (page) => window.app.switchPage(page);
window.switchView = (view) => window.app.switchView(view);
