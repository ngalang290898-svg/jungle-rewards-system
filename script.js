// Complete Student Data - All 72 Students
const COMPLETE_DATA = {
  "4 Pearl": {
    "Pre-A1": {
      "üêØ The Mighty Tigers": {
        totalPoints: 245,
        members: [
          { name: "ADELLA KAISARA BINTI AMDAN", points: 45 },
          { name: "AHMAD JIHAD BIN ABDULLAH", points: 50 },
          { name: "ANJENNY PAILEE", points: 40 },
          { name: "AZIZAH ALISHA BINTI AZMIZAN AZRIN", points: 55 },
          { name: "AZIB ARYAN BIN A.RAHMAN", points: 55 }
        ]
      },
      "üêº The Brave Bears": {
        totalPoints: 210,
        members: [
          { name: "GIDEON GALE GARRY", points: 40 },
          { name: "FAREL BIN ARSID", points: 45 },
          { name: "INDRA PUTRA BIN JAINI", points: 35 },
          { name: "MOHAMMAD ABDUL KHALIQ BIN NAISAR", points: 45 },
          { name: "MOHAMAD NUR ZAQIF ZIQRI BIN MOHAMAD TINO", points: 45 }
        ]
      },
      "üê∞ The Swift Rabbits": {
        totalPoints: 230,
        members: [
          { name: "MUHAMMAD DANISH IFWAT BIN MUHAMMAD IFFAD", points: 50 },
          { name: "MOHAMAD AL HAKIM BIN MOHAMAD RAJAN", points: 45 },
          { name: "MOHAMAD RAID RUZAIMIE BIN MOHD SALIHAN", points: 40 },
          { name: "NUR AIN HAWA SYAKIELA BINTI ILHAM SUKRI", points: 45 },
          { name: "MUHAMMAD IRMANSYAH BIN ABDUL BASIR", points: 50 }
        ]
      }
    },
    "Low A1": {
      "ü¶ä The Clever Foxes": {
        totalPoints: 275,
        members: [
          { name: "MUHAMMAD YUSUF BIN ANNUAR", points: 55 },
          { name: "NOR ZAMIRAH QALISYAH BINTI MOHD ZAMIRUL", points: 60 },
          { name: "MUHAMMAD RAYYAN BIN ARNER", points: 50 },
          { name: "MUHAMMAD AKIF QAIYYUM BIN RANO", points: 55 },
          { name: "MUHAMMAD ASNAWI BIN HAMZAH", points: 55 }
        ]
      }
    },
    "Mid A1": {
      "ü¶Ö The Brave Eagles": {
        totalPoints: 285,
        members: [
          { name: "NOOR QASEH NADIA BINTI ABDULLAH", points: 60 },
          { name: "MIESYA NUR SYAZIERRA BINTI ISA", points: 55 },
          { name: "MOHAMAD WAN MARZUQI BIN MAZLAN", points: 55 },
          { name: "NOR FATIYYAH FARAHANIE BINTI ZAINI", points: 60 },
          { name: "MUHAMMAD NAZRIN BIN ZULLASRI", points: 55 }
        ]
      },
      "üêÜ The Swift Panthers": {
        totalPoints: 270,
        members: [
          { name: "MUHAMMAD AL FATIH BIN MOHAMAD FAIZAL AFINDI", points: 55 },
          { name: "NUBHAN BIN JAMIL", points: 50 },
          { name: "NURUL FARAH KHALISYAH BINTI PABIL", points: 55 },
          { name: "NURUL ALISA SAPPIKA BINTI ABDULLAH", points: 55 },
          { name: "MUHAMMAD FAIS BIN HENRAL", points: 55 }
        ]
      }
    },
    "High A1": {
      "ü¶ã The Shining Butterflies": {
        totalPoints: 330,
        members: [
          { name: "PUTRI ARIESA ZULAIKHA BINTI JUISAL", points: 60 },
          { name: "PUTERI MYA ARLISSA BINTI MOHD BAKRI", points: 55 },
          { name: "MUHAMMAD IRFAN BIN UDAYKUMAR CHOCKALINGAM SHANMUGAM", points: 55 },
          { name: "MUHAMMAD IKMAL BIN RIDSMAR", points: 50 },
          { name: "SYARIF ABDUL HALIM BIN ALNASIR", points: 55 },
          { name: "SITI NUR PUTRI BALQISHAH BINTI MOHD ZALANI", points: 55 }
        ]
      }
    }
  },
  "4 Crystal": {
    "Pre-A1": {
      "üêí The Playful Monkeys": {
        totalPoints: 405,
        members: [
          { name: "ASHIRAH BINTI ASIS", points: 45 },
          { name: "AIDIL FAZLI BIN ABDULLAH", points: 45 },
          { name: "AL SYAMIR BIN ABDUL NASIR", points: 45 },
          { name: "ELYANA BINTI MARTIN", points: 45 },
          { name: "HAFIZAM AKIM BIN ABDUL AZIS", points: 45 },
          { name: "HAIJAL BIN JAINAL", points: 45 },
          { name: "IMANINA HUSNA BINTI MUHAMMAD SALI", points: 45 },
          { name: "MOHAMMAD HAIKAL HAKIMI BIN ABDULLAH", points: 45 },
          { name: "MOHAMMAD AIREIL DANNISH BIN ASYRAT", points: 45 }
        ]
      },
      "ü¶â The Wise Owls": {
        totalPoints: 360,
        members: [
          { name: "MOHAMED DANIEL IMAN BIN BOHARI", points: 45 },
          { name: "MOHAMAD RAIDI SAHRIMAL BIN JAMRI", points: 45 },
          { name: "MUHAMAD AZRUL BIN AZLAN", points: 45 },
          { name: "MUHAMMAD NOOR FAZRIE BIN AMRAN", points: 45 },
          { name: "NUR ARYSA QAISARA BINTI MASRI", points: 45 },
          { name: "NAEL BIN MOHD NIJAR", points: 45 },
          { name: "NIRWANSA BIN RANO", points: 45 },
          { name: "NORAINA BINTI ABDULLAH", points: 45 }
        ]
      },
      "üê∫ The Fearless Wolves": {
        totalPoints: 360,
        members: [
          { name: "NUR PATIAH BINTI ABDULLAH", points: 45 },
          { name: "NUR KHATIJA BINTI IBRAHIM", points: 45 },
          { name: "NURUL HUMAIRA BINTI ASANAL", points: 45 },
          { name: "NAISHA BINTI AZMAN", points: 45 },
          { name: "NUR AFFINA AULIA BINTI RIZAL", points: 45 },
          { name: "MUHAMMAD DANNY ASHRAF BIN ABDULLAH", points: 45 },
          { name: "MUHAMMAD AADAM KHALIF BIN MUHAMMAD HAIRUL NIZAM", points: 45 },
          { name: "NURAISYAH NATASYA BINTI MOHD HANIF WASNI", points: 45 }
        ]
      },
      "ü¶Å The Glorious Lions": {
        totalPoints: 495,
        members: [
          { name: "NURAZLIYANAH BATRISHA BINTI SABRI", points: 45 },
          { name: "MOHAMAD RIZANI SYAHIZIEY BIN ABDULLAH", points: 45 },
          { name: "MUHAMMAD HAIZUL BIN OMAR", points: 45 },
          { name: "MUHAMMAD QAWIEM RAFIQ BIN RAZLAN", points: 45 },
          { name: "NUR AZMINA BINTI ABDULLAH", points: 45 },
          { name: "MOHAMMAD SHAZWAN BIN NAZMI", points: 45 },
          { name: "NURUL ALYA ZULAIKHA BINTI SINAKASONI", points: 45 },
          { name: "NURLUTHFIA AZZAHRA BINTI JUWAWI", points: 45 },
          { name: "SITI UMAIRAH BINTI IBRAHIM", points: 45 },
          { name: "WHIRYAN SHAH BIN MOHD NORHISMAL", points: 45 },
          { name: "MUHAMMAD HAFIZ UQASYAH BIN ABDULLAH", points: 45 }
        ]
      }
    }
  }
};

// ========== PERFORMANCE & ACCESSIBILITY ENHANCEMENTS ==========

class JungleRewardsSystem {
    constructor() {
        this.currentClass = '4 Pearl';
        this.currentView = 'visitor';
        this.isAuthenticated = false;
        this.storageKey = 'jungleRewardsData';
        this.currentTheme = 'dark';
        this.initialized = false;
        this.animationFrameId = null;
        
        // Performance monitoring
        this.lowPerformanceMode = this.detectLowPerformance();
    }

    // ========== PERFORMANCE OPTIMIZATIONS ==========
    
    /**
     * Detect low-performance devices for optimized rendering
     */
    detectLowPerformance() {
        // Check for low-end devices
        const hasLowMemory = navigator.deviceMemory && navigator.deviceMemory < 4;
        const hasLowCores = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 2;
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        return hasLowMemory || hasLowCores || isMobile;
    }

    // ========== INITIALIZATION ==========
    
    /**
     * Main app initialization with error handling
     */
    initializeApp() {
        console.log('üöÄ Initializing Futuristic Jungle Rewards System...');
        
        try {
            this.initializeData();
            this.initializeTheme();
            this.initializeBackground();
            
            // Check for existing authentication
            const savedAuth = localStorage.getItem('jungleAuthenticated');
            if (savedAuth === 'true') {
                this.isAuthenticated = true;
                this.toggleAuthState(true);
            }

            this.loadInitialData();
            this.setupEventListeners();
            
            console.log('‚úÖ App initialized successfully');
            this.initialized = true;
            
        } catch (error) {
            console.error('‚ùå Error during app initialization:', error);
            this.showToast('Error initializing app. Please refresh the page.', 'error');
        } finally {
            // Always hide loading screen, even if there's an error
            this.hideLoadingScreen();
        }
    }

    initializeData() {
        let storedData = localStorage.getItem(this.storageKey);
        
        if (!storedData) {
            localStorage.setItem(this.storageKey, JSON.stringify(COMPLETE_DATA));
            console.log('‚ú® System initialized with all student data');
        }
    }

    initializeTheme() {
        const savedTheme = localStorage.getItem('jungleTheme') || 'dark';
        this.currentTheme = savedTheme;
        document.documentElement.setAttribute('data-theme', savedTheme);
        this.updateThemeIcon();
    }

    initializeBackground() {
        if (this.lowPerformanceMode) {
            console.log('üöÄ Using lightweight background for better performance');
            this.setupParticleBackground(); // Lightweight fallback
            return;
        }
        
        // Only load Three.js on capable devices
        if (window.THREE) {
            this.setupWebGLBackground();
        } else {
            this.setupParticleBackground();
        }
    }

    // ========== THEME MANAGEMENT ==========
    
    toggleTheme() {
        this.currentTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', this.currentTheme);
        localStorage.setItem('jungleTheme', this.currentTheme);
        this.updateThemeIcon();
        this.showToast(`${this.currentTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è'} Theme switched to ${this.currentTheme}`, 'info');
    }

    updateThemeIcon() {
        const themeIcon = document.querySelector('#themeToggle i');
        if (themeIcon) {
            themeIcon.className = this.currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
    }

    // ========== BACKGROUND ANIMATIONS ==========
    
    setupParticleBackground() {
        const container = document.getElementById('particle-overlay');
        if (!container) {
            console.warn('Particle overlay container not found');
            return;
        }

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        container.appendChild(canvas);

        let width = window.innerWidth;
        let height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;

        const particles = [];
        const particleCount = 50;

        class Particle {
            constructor() {
                this.reset();
            }

            reset() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.size = Math.random() * 3 + 1;
                this.speedX = Math.random() * 2 - 1;
                this.speedY = Math.random() * 2 - 1;
                this.color = `hsl(${Math.random() * 60 + 160}, 70%, 60%)`;
                this.alpha = Math.random() * 0.5 + 0.2;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                if (this.x > width || this.x < 0) this.speedX *= -1;
                if (this.y > height || this.y < 0) this.speedY *= -1;

                this.alpha = 0.2 + 0.3 * Math.sin(Date.now() * 0.001 + this.x * 0.01);
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // Create particles
        for (let i = 0; i < particleCount; i++) {
            particles.push(new Particle());
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);
            
            particles.forEach(particle => {
                particle.update();
                particle.draw();
            });

            requestAnimationFrame(animate);
        }

        animate();

        // Handle resize
        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        });
    }

    setupWebGLBackground() {
        const container = document.getElementById('webgl-container');
        if (!container) {
            console.warn('WebGL container not found');
            return;
        }
        
        if (!window.THREE) {
            console.warn('Three.js not loaded');
            return;
        }

        try {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ 
                alpha: true, 
                antialias: !this.lowPerformanceMode // Disable antialiasing on low-perf devices
            });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0);
            container.appendChild(renderer.domElement);

            // Simplified geometries for better performance
            const geometries = [
                new THREE.IcosahedronGeometry(1, 0),
                new THREE.OctahedronGeometry(1, 0)
            ];

            const materials = [
                new THREE.MeshBasicMaterial({ color: 0x00ffc3, wireframe: true }),
                new THREE.MeshBasicMaterial({ color: 0x00a3ff, wireframe: true })
            ];

            const meshes = [];
            const meshCount = this.lowPerformanceMode ? 4 : 8; // Reduce objects on low-perf
            
            for (let i = 0; i < meshCount; i++) {
                const geometry = geometries[Math.floor(Math.random() * geometries.length)];
                const material = materials[Math.floor(Math.random() * materials.length)];
                const mesh = new THREE.Mesh(geometry, material);
                
                mesh.position.x = (Math.random() - 0.5) * 20;
                mesh.position.y = (Math.random() - 0.5) * 20;
                mesh.position.z = (Math.random() - 0.5) * 10;
                
                scene.add(mesh);
                meshes.push(mesh);
            }

            camera.position.z = 15;

            // Throttled animation loop
            let lastTime = 0;
            const fpsInterval = 1000 / 30; // Target 30 FPS
            
            const animate = (currentTime) => {
                this.animationFrameId = requestAnimationFrame(animate);
                
                const delta = currentTime - lastTime;
                if (delta > fpsInterval) {
                    lastTime = currentTime - (delta % fpsInterval);
                    
                    meshes.forEach((mesh, index) => {
                        mesh.rotation.x += 0.005;
                        mesh.rotation.y += 0.008;
                        mesh.position.y += Math.sin(currentTime * 0.001 + index) * 0.01;
                    });

                    renderer.render(scene, camera);
                }
            };

            animate(0);

            // Optimized resize handler
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                }, 250);
            });

        } catch (error) {
            console.log('WebGL not supported, falling back to particles');
            this.setupParticleBackground();
        }
    }

    // ========== REWARD ANIMATIONS ==========
    
    playConfetti() {
        const canvas = document.getElementById('confettiCanvas');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const confettiPieces = [];
        const confettiCount = 150;

        class Confetti {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = -20;
                this.size = Math.random() * 10 + 5;
                this.speedY = Math.random() * 3 + 2;
                this.speedX = Math.random() * 4 - 2;
                this.color = `hsl(${Math.random() * 360}, 100%, 50%)`;
                this.rotation = Math.random() * 360;
                this.rotationSpeed = Math.random() * 10 - 5;
            }

            update() {
                this.y += this.speedY;
                this.x += this.speedX;
                this.rotation += this.rotationSpeed;
                
                return this.y < canvas.height;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation * Math.PI / 180);
                ctx.fillStyle = this.color;
                ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
                ctx.restore();
            }
        }

        // Create confetti
        for (let i = 0; i < confettiCount; i++) {
            confettiPieces.push(new Confetti());
        }

        function animateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let activePieces = 0;
            
            confettiPieces.forEach(confetti => {
                if (confetti.update()) {
                    confetti.draw();
                    activePieces++;
                }
            });

            if (activePieces > 0) {
                requestAnimationFrame(animateConfetti);
            }
        }

        animateConfetti();

        // Auto-remove canvas after animation
        setTimeout(() => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }, 3000);
    }

    showRewardAnimation(message, points = 0) {
        const container = document.getElementById('rewardContainer');
        if (!container) return;

        const rewardElement = document.createElement('div');
        rewardElement.className = 'reward-popup';
        rewardElement.innerHTML = `
            <div class="reward-content">
                <div class="reward-icon">üéâ</div>
                <div class="reward-message">${message}</div>
                ${points ? `<div class="reward-points">+${points} points</div>` : ''}
            </div>
        `;

        container.appendChild(rewardElement);

        // Remove after animation
        setTimeout(() => {
            rewardElement.remove();
        }, 3000);
    }

    // ========== DATA MANAGEMENT ==========
    
    /**
     * Safe data retrieval from LocalStorage with fallback
     */
    getData() {
        try {
            const storedData = localStorage.getItem(this.storageKey);
            if (storedData) {
                return JSON.parse(storedData);
            }
        } catch (error) {
            console.warn('LocalStorage read failed, using fallback data:', error);
        }
        
        // Fallback to initial data
        return this.getFallbackData();
    }

    getFallbackData() {
        // Deep clone to prevent mutation of original data
        return JSON.parse(JSON.stringify(COMPLETE_DATA));
    }

    saveData(data) {
        try {
            localStorage.setItem(this.storageKey, JSON.stringify(data));
            return true;
        } catch (error) {
            console.error('LocalStorage write failed:', error);
            this.showToast('Failed to save data. Changes may be lost on refresh.', 'error');
            return false;
        }
    }

    loadInitialData() {
        console.log('üìä Loading complete data...');
        const data = this.getData();
        this.updateGroupsDisplay(data);
        this.updateLastUpdated();
        this.updateSystemStats(data);
    }

    updateGroupsDisplay(groupsData) {
        const groupsGrid = document.getElementById('groupsGrid');
        
        if (!groupsGrid) {
            console.error('Groups grid element not found');
            return;
        }

        let html = '';
        let totalGroups = 0;

        for (const [className, levels] of Object.entries(groupsData)) {
            if (className !== this.currentClass) continue;
            
            for (const [level, groups] of Object.entries(levels)) {
                for (const [groupName, groupData] of Object.entries(groups)) {
                    totalGroups++;
                    
                    const groupPoints = groupData.totalPoints || 0;
                    const memberCount = groupData.members ? groupData.members.length : 0;
                    
                    html += `
                        <div class="group-card" data-class="${className}" data-group="${groupName}">
                            <div class="group-header">
                                <div class="group-name">${groupName}</div>
                                <div class="group-level">
                                    <i class="fas fa-layer-group"></i>
                                    ${level} ‚Ä¢ ${className}
                                </div>
                            </div>
                            
                            <div class="group-stats">
                                <div class="points-display">
                                    <div class="points-icon">
                                        <i class="fas fa-gem"></i>
                                    </div>
                                    <div class="points-info">
                                        <div class="points-value">${groupPoints}</div>
                                        <div class="points-label">Crystals</div>
                                    </div>
                                </div>
                                <div class="member-count">
                                    <i class="fas fa-users"></i>
                                    ${memberCount} members
                                </div>
                            </div>
                            
                            <div class="group-actions">
                                <button class="group-action-btn view-members" 
                                        onclick="app.showGroupMembers('${className}', '${groupName}', '${level}')">
                                    <i class="fas fa-list"></i>
                                    View Members
                                </button>
                                ${this.isAuthenticated ? `
                                <button class="group-action-btn group-bonus" 
                                        onclick="app.applyGroupBonus('${groupName}', '${className}')">
                                    <i class="fas fa-star"></i>
                                    +10 Bonus
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }
        }

        groupsGrid.innerHTML = html || `
            <div class="loading-groups">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Discovering jungle tribes...</p>
            </div>
        `;
        
        console.log(`‚úÖ Displayed ${totalGroups} groups for ${this.currentClass}`);
    }

    showGroupMembers(className, groupName, level) {
        const data = this.getData();
        const groupData = data[className]?.[level]?.[groupName];
        
        if (!groupData) {
            this.showToast('Group data not found', 'error');
            return;
        }

        this.showGroupModal(className, groupName, level, groupData.members);
    }

    showGroupModal(className, groupName, level, students) {
        // Remove existing modal if any
        const existingModal = document.getElementById('groupModal');
        if (existingModal) {
            existingModal.remove();
        }

        const modalHTML = `
            <div class="modal" id="groupModal">
                <div class="modal-content premium-modal">
                    <div class="modal-header">
                        <h3><i class="fas fa-users"></i> ${groupName}</h3>
                        <button class="close-modal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="group-modal-header">
                            <div class="group-info">
                                <div class="group-class">${className}</div>
                                <div class="group-level">${level}</div>
                            </div>
                            <div class="group-stats-summary">
                                <div class="stat">
                                    <i class="fas fa-users"></i>
                                    <span>${students.length} Members</span>
                                </div>
                                <div class="stat">
                                    <i class="fas fa-gem"></i>
                                    <span>${students.reduce((sum, student) => sum + (student.points || 0), 0)} Total Crystals</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="members-list">
                            <h4>Group Members</h4>
                            ${students.map((student, index) => `
                                <div class="member-item ${this.isAuthenticated ? 'editable' : ''}">
                                    <div class="member-info">
                                        <div class="member-rank">${index + 1}</div>
                                        <div class="member-details">
                                            <div class="member-name">${student.name}</div>
                                            <div class="member-points">${student.points} crystals</div>
                                        </div>
                                    </div>
                                    ${this.isAuthenticated ? `
                                    <div class="member-actions">
                                        <button class="point-btn add-point" onclick="app.updateStudentPoints('${student.name.replace(/'/g, "\\'")}', 1)" title="Add 1 point">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <button class="point-btn remove-point" onclick="app.updateStudentPoints('${student.name.replace(/'/g, "\\'")}', -1)" title="Remove 1 point">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <button class="point-btn bonus-point" onclick="app.updateStudentPoints('${student.name.replace(/'/g, "\\'")}', 5)" title="Add 5 points">
                                            <i class="fas fa-star"></i>
                                        </button>
                                    </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        const modal = document.getElementById('groupModal');
        
        modal.querySelector('.close-modal').addEventListener('click', () => {
            modal.remove();
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    // ========== POINT MANAGEMENT ==========
    
    updateStudentPoints(studentName, pointsChange) {
        if (!this.isAuthenticated) {
            this.showToast('Please login as teacher first', 'warning');
            return;
        }

        const data = this.getData();
        let studentFound = false;

        for (const [className, levels] of Object.entries(data)) {
            for (const [level, groups] of Object.entries(levels)) {
                for (const [groupName, groupData] of Object.entries(groups)) {
                    const studentIndex = groupData.members.findIndex(s => s.name === studentName);
                    if (studentIndex !== -1) {
                        studentFound = true;
                        const student = groupData.members[studentIndex];
                        const newPoints = Math.max(0, student.points + pointsChange);
                        
                        student.points = newPoints;
                        groupData.totalPoints = groupData.members.reduce((sum, s) => sum + s.points, 0);
                        
                        this.saveData(data);
                        this.loadInitialData();
                        
                        const action = pointsChange >= 0 ? 'added' : 'deducted';
                        const emoji = pointsChange >= 0 ? '‚ú®' : '‚ö†Ô∏è';
                        
                        // Show reward animation for positive points
                        if (pointsChange > 0) {
                            this.showRewardAnimation(`${studentName} earned ${pointsChange} points!`, pointsChange);
                            this.playConfetti();
                        }
                        
                        this.showToast(`${emoji} ${Math.abs(pointsChange)} points ${action} for ${studentName}`, 'success');
                        
                        const modal = document.getElementById('groupModal');
                        if (modal) modal.remove();
                        
                        return;
                    }
                }
            }
        }

        if (!studentFound) {
            this.showToast('Student not found', 'error');
        }
    }

    applyGroupBonus(groupName, className) {
        if (!this.isAuthenticated) {
            this.showToast('Please login as teacher first', 'warning');
            return;
        }

        const data = this.getData();
        const groupData = data[className];

        if (!groupData) {
            this.showToast('Class not found', 'error');
            return;
        }

        let groupFound = false;

        for (const [level, groups] of Object.entries(groupData)) {
            if (groups[groupName]) {
                groupFound = true;
                const group = groups[groupName];
                
                group.members.forEach(student => {
                    student.points += 10;
                });
                
                group.totalPoints = group.members.reduce((sum, s) => sum + s.points, 0);
                
                this.saveData(data);
                this.loadInitialData();
                
                this.showRewardAnimation(`${groupName} received +10 bonus!`, 10);
                this.playConfetti();
                this.showToast(`üéâ +10 points bonus applied to ${groupName}`, 'success');
                break;
            }
        }

        if (!groupFound) {
            this.showToast('Group not found', 'error');
        }
    }

    resetAllPoints() {
        if (!this.isAuthenticated) {
            this.showToast('Please login as teacher first', 'warning');
            return;
        }

        if (!confirm('‚ö†Ô∏è Are you sure you want to reset ALL points to zero?\n\nThis action cannot be undone!')) {
            return;
        }

        const data = this.getData();
        
        for (const [className, levels] of Object.entries(data)) {
            for (const [level, groups] of Object.entries(levels)) {
                for (const [groupName, groupData] of Object.entries(groups)) {
                    groupData.members.forEach(student => {
                        student.points = 0;
                    });
                    groupData.totalPoints = 0;
                }
            }
        }
        
        this.saveData(data);
        this.loadInitialData();
        
        this.showToast('‚úÖ All points have been reset to zero', 'success');
    }

    initializeSystemData() {
        if (!this.isAuthenticated) {
            this.showToast('Please login as teacher first', 'warning');
            return;
        }

        if (!confirm('üîÑ Initialize system data?\n\nThis will reset all students and points to initial state.')) {
            return;
        }

        localStorage.removeItem(this.storageKey);
        this.initializeData();
        this.loadInitialData();
        
        this.showToast('‚úÖ System reinitialized with original data', 'success');
    }

    // ========== UI UPDATES ==========
    
    updateLastUpdated() {
        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (lastUpdatedElement) {
            const now = new Date();
            lastUpdatedElement.textContent = `Updated: ${now.toLocaleTimeString()}`;
        }
    }

    updateSystemStats(data) {
        const systemStats = document.getElementById('systemStats');
        if (!systemStats) return;

        let totalStudents = 0;
        let totalCrystals = 0;
        let totalGroups = 0;

        for (const [className, levels] of Object.entries(data)) {
            for (const [level, groups] of Object.entries(levels)) {
                for (const [groupName, groupData] of Object.entries(groups)) {
                    totalGroups++;
                    totalStudents += groupData.members.length;
                    totalCrystals += groupData.totalPoints;
                }
            }
        }

        systemStats.innerHTML = `
            <div class="stat-item">
                <i class="fas fa-users"></i>
                <span>Total Students: ${totalStudents}</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-gem"></i>
                <span>Total Crystals: ${totalCrystals}</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-layer-group"></i>
                <span>Active Groups: ${totalGroups}</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-clock"></i>
                <span>Last Updated: ${new Date().toLocaleTimeString()}</span>
            </div>
        `;
    }

    toggleAuthState(isAuthenticated) {
        const appContainer = document.getElementById('app');
        if (appContainer) {
            if (isAuthenticated) {
                appContainer.classList.add('authenticated');
                this.showToast('üîì Teacher mode activated', 'success');
            } else {
                appContainer.classList.remove('authenticated');
            }
        }
    }

    // ========== VIEW MANAGEMENT ==========
    
    switchView(view) {
        this.currentView = view;
        const viewButtons = document.querySelectorAll('.view-btn');
        
        viewButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.view === view) {
                btn.classList.add('active');
            }
        });

        if (view === 'teacher' && !this.isAuthenticated) {
            this.showModal('loginModal');
        } else {
            this.showToast(`Switched to ${view} view`, 'info');
        }
    }

    switchClass(className) {
        this.currentClass = className;
        const classDisplay = document.getElementById('currentClassDisplay');
        if (classDisplay) {
            classDisplay.innerHTML = `<i class="fas fa-graduation-cap"></i> ${className}`;
        }
        
        this.loadInitialData();
    }

    switchPage(page) {
        document.querySelectorAll('.page').forEach(p => {
            p.classList.remove('active');
        });

        const targetPage = document.getElementById(`${page}Page`);
        if (targetPage) {
            targetPage.classList.add('active');
        }

        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.dataset.page === page) {
                link.classList.add('active');
            }
        });

        if (page === 'dashboard') {
            this.loadInitialData();
        } else if (page === 'leaderboard') {
            this.loadLeaderboardData();
        }

        this.showToast(`Navigated to ${page.charAt(0).toUpperCase() + page.slice(1)}`, 'info');
    }

    // ========== FIXED LEADERBOARD SYSTEM ==========
    
    /**
     * Load both group and individual leaderboard data
     */
    loadLeaderboardData(classFilter = 'all') {
        this.loadGroupsLeaderboardData(classFilter);
        this.loadIndividualsLeaderboardData(classFilter);
    }

    loadGroupsLeaderboardData(classFilter = 'all') {
        const groupsContent = document.getElementById('groupsLeaderboardContent');
        if (!groupsContent) return;

        const data = this.getData();
        let groupsList = [];

        for (const [className, levels] of Object.entries(data)) {
            if (classFilter !== 'all' && className !== classFilter) continue;
            
            for (const [level, groups] of Object.entries(levels)) {
                for (const [groupName, groupData] of Object.entries(groups)) {
                    groupsList.push({
                        name: groupName,
                        class: className,
                        level: level,
                        points: groupData.totalPoints || 0,
                        members: groupData.members ? groupData.members.length : 0
                    });
                }
            }
        }

        groupsList.sort((a, b) => b.points - a.points);

        let groupsHtml = '';
        groupsList.forEach((group, index) => {
            const rankClass = index < 3 ? `rank-${index + 1}` : '';
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
            const ariaLabel = `Rank ${index + 1}: ${group.name} with ${group.points} crystals`;
            
            groupsHtml += `
                <div class="leaderboard-item" role="listitem" aria-label="${ariaLabel}">
                    <div class="rank ${rankClass}" aria-hidden="true">${medal} ${index + 1}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">
                            ${group.name}
                            <span class="group-badge">${group.class}</span>
                        </div>
                        <div class="leaderboard-meta">
                            ${group.level} ‚Ä¢ ${group.members} members
                        </div>
                    </div>
                    <div class="leaderboard-points" aria-label="${group.points} crystals">
                        ${group.points}
                    </div>
                </div>
            `;
        });

        groupsContent.innerHTML = groupsHtml || '<div class="loading-leaderboard"><p>No group data found</p></div>';
        
        // Announce update for screen readers
        this.announceToScreenReader(`Groups leaderboard updated with ${groupsList.length} teams`);
    }

    /**
     * FIXED: Individual leaderboard now properly shows all students
     */
    loadIndividualsLeaderboardData(classFilter = 'all') {
        const individualsContent = document.getElementById('individualsLeaderboardContent');
        if (!individualsContent) return;

        const data = this.getData();
        let allStudents = [];

        // Collect all students with defensive data parsing
        for (const [className, levels] of Object.entries(data)) {
            if (classFilter !== 'all' && className !== classFilter) continue;
            
            for (const [level, groups] of Object.entries(levels)) {
                for (const [groupName, groupData] of Object.entries(groups)) {
                    // Safe member iteration
                    const members = groupData.members || [];
                    members.forEach(student => {
                        if (student && student.name) {
                            allStudents.push({
                                name: student.name,
                                points: student.points || 0, // Default to 0 if missing
                                class: className,
                                group: groupName,
                                level: level
                            });
                        }
                    });
                }
            }
        }

        // Sort by points (descending)
        allStudents.sort((a, b) => b.points - a.points);

        let individualsHtml = '';
        if (allStudents.length > 0) {
            allStudents.forEach((student, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                const ariaLabel = `Rank ${index + 1}: ${student.name} from ${student.group} with ${student.points} crystals`;
                
                individualsHtml += `
                    <div class="leaderboard-item" role="listitem" aria-label="${ariaLabel}">
                        <div class="rank ${rankClass}" aria-hidden="true">${medal} ${index + 1}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">
                                ${student.name}
                                <span class="group-badge">${student.group}</span>
                            </div>
                            <div class="leaderboard-meta">
                                ${student.class} ‚Ä¢ ${student.level}
                            </div>
                        </div>
                        <div class="leaderboard-points" aria-label="${student.points} crystals">
                            ${student.points}
                        </div>
                    </div>
                `;
            });
        } else {
            individualsHtml = '<div class="loading-leaderboard"><p>No student data found</p></div>';
        }

        individualsContent.innerHTML = individualsHtml;
        
        // Announce update for screen readers
        this.announceToScreenReader(`Individual leaderboard updated with ${allStudents.length} students`);
    }

    switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tab === tab) {
                btn.classList.add('active');
            }
        });

        document.querySelectorAll('.leaderboard-tab').forEach(tabElement => {
            tabElement.classList.remove('active');
            if (tabElement.id === `${tab}Leaderboard`) {
                tabElement.classList.add('active');
            }
        });

        // Load appropriate data when tab changes
        const classFilter = document.getElementById('leaderboardClassSelector')?.value || 'all';
        if (tab === 'groups') {
            this.loadGroupsLeaderboardData(classFilter);
        } else if (tab === 'individuals') {
            this.loadIndividualsLeaderboardData(classFilter);
        }

        this.announceToScreenReader(`Switched to ${tab} leaderboard view`);
    }

    // ========== ACCESSIBILITY ENHANCEMENTS ==========
    
    /**
     * Announce updates to screen readers
     */
    announceToScreenReader(message) {
        // Create aria-live region for screen reader announcements
        let liveRegion = document.getElementById('a11y-live-region');
        if (!liveRegion) {
            liveRegion = document.createElement('div');
            liveRegion.id = 'a11y-live-region';
            liveRegion.setAttribute('aria-live', 'polite');
            liveRegion.setAttribute('aria-atomic', 'true');
            liveRegion.style.cssText = 'position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;';
            document.body.appendChild(liveRegion);
        }
        
        liveRegion.textContent = message;
    }

    // ========== MODAL MANAGEMENT ==========
    
    showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }

    // ========== NOTIFICATION SYSTEM ==========
    
    showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas fa-${this.getToastIcon(type)}"></i>
            </div>
            <div class="toast-message">${message}</div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    getToastIcon(type) {
        const icons = {
            success: 'check-circle',
            error: 'exclamation-triangle',
            warning: 'exclamation-circle',
            info: 'info-circle'
        };
        return icons[type] || 'info-circle';
    }

    // ========== AUTHENTICATION ==========
    
    verifyAdminPassword(password) {
        if (password === 'jungle123') {
            this.isAuthenticated = true;
            localStorage.setItem('jungleAuthenticated', 'true');
            this.toggleAuthState(true);
            this.showToast('üîì Admin access granted!', 'success');
            this.hideModal('loginModal');
            return true;
        } else {
            this.showToast('Invalid password', 'error');
            return false;
        }
    }

    logout() {
        this.isAuthenticated = false;
        localStorage.removeItem('jungleAuthenticated');
        this.toggleAuthState(false);
        this.showToast('Logged out successfully', 'info');
    }

    // ========== LOADING SCREEN ==========
    
    hideLoadingScreen() {
        console.log('üé¨ Hiding loading screen...');
        
        const loadingScreen = document.getElementById('loadingScreen');
        const appContainer = document.getElementById('app');
        
        if (loadingScreen && appContainer) {
            // First, show the app container
            appContainer.classList.remove('hidden');
            
            // Then fade out the loading screen
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.8s ease';
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                console.log('‚úÖ Loading screen hidden');
                
                // Show welcome toast
                this.showToast('Welcome to the Magical Jungle! üåø', 'success');
            }, 800);
        } else {
            console.error('‚ùå Could not find loading screen or app container');
            // Fallback: force show app after timeout
            setTimeout(() => {
                if (appContainer) {
                    appContainer.classList.remove('hidden');
                }
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
            }, 2000);
        }
    }

    // ========== EVENT LISTENERS ==========
    
    /**
     * Safe event listener setup with error handling
     */
    setupEventListeners() {
        console.log('üîß Setting up event listeners...');
        
        // Safe DOM query helper
        const safeQuery = (selector, context = document) => {
            const element = context.querySelector(selector);
            if (!element) {
                console.warn(`Element not found: ${selector}`);
            }
            return element;
        };

        try {
            // Enhanced navigation with keyboard support
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = e.currentTarget.dataset.page;
                    this.switchPage(page);
                });
                
                // Keyboard accessibility
                link.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        link.click();
                    }
                });
            });

            // Theme toggle
            const themeToggle = safeQuery('#themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    this.toggleTheme();
                });
            }

            // Class selector
            const classSelector = safeQuery('#classSelector');
            if (classSelector) {
                classSelector.value = this.currentClass;
                classSelector.addEventListener('change', (e) => {
                    this.switchClass(e.target.value);
                });
            }

            // Leaderboard class selector with change detection
            const leaderboardClassSelector = safeQuery('#leaderboardClassSelector');
            if (leaderboardClassSelector) {
                leaderboardClassSelector.addEventListener('change', (e) => {
                    this.loadLeaderboardData(e.target.value);
                });
            }

            // View toggle
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    this.switchView(e.currentTarget.dataset.view);
                });
            });

            // Tab buttons with keyboard navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tab = e.currentTarget.dataset.tab;
                    this.switchTab(tab);
                });
                
                btn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });
            });

            // Login button
            const loginBtn = safeQuery('#loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    this.showModal('loginModal');
                });
            }

            // Logout button
            const logoutBtn = safeQuery('#logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    this.logout();
                });
            }

            // Login form submission
            const submitLogin = safeQuery('#submitLogin');
            const adminPassword = safeQuery('#adminPassword');
            
            if (submitLogin && adminPassword) {
                submitLogin.addEventListener('click', () => {
                    const password = adminPassword.value.trim();
                    if (password) {
                        this.verifyAdminPassword(password);
                    } else {
                        this.showToast('Please enter password', 'warning');
                    }
                });

                adminPassword.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitLogin.click();
                    }
                });
            }

            // Refresh button
            const refreshBtn = safeQuery('#refreshData');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    this.loadInitialData();
                    this.showToast('Data refreshed', 'success');
                });
            }

            // Admin buttons
            const resetBtn = safeQuery('#resetAllPoints');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    this.resetAllPoints();
                });
            }

            const initBtn = safeQuery('#initializeData');
            if (initBtn) {
                initBtn.addEventListener('click', () => {
                    this.initializeSystemData();
                });
            }

            const exportBtn = safeQuery('#exportData');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    this.exportData();
                });
            }

            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        this.hideModal(modal.id);
                    }
                });
            });

            // Close modals on background click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.hideModal(modal.id);
                    }
                });
            });

            // Escape key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.hideModal('loginModal');
                    const groupModal = document.getElementById('groupModal');
                    if (groupModal) groupModal.remove();
                }
            });

            // Home page CTA buttons
            document.querySelectorAll('[data-page]').forEach(btn => {
                if (btn.closest('.hero-actions')) {
                    btn.addEventListener('click', (e) => {
                        const page = e.currentTarget.dataset.page;
                        this.switchPage(page);
                    });
                }
            });

            console.log('‚úÖ Event listeners setup complete');
        } catch (error) {
            console.error('‚ùå Error setting up event listeners:', error);
        }
    }

    // ========== DATA EXPORT ==========
    
    exportData() {
        const data = this.getData();
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'jungle-rewards-data.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        this.showToast('Data exported successfully', 'success');
    }

    // ========== RESOURCE CLEANUP ==========
    
    /**
     * Clean up resources to prevent memory leaks
     */
    cleanup() {
        // Cancel animation frames to prevent memory leaks
        if (this.animationFrameId) {
            cancelAnimationFrame(this.animationFrameId);
        }
    }
}

// ========== DEFERRED INITIALIZATION ==========

let appInstance = null;

document.addEventListener('DOMContentLoaded', () => {
    console.log('üåø DOM loaded - initializing Futuristic Jungle Rewards System');
    
    // Defer non-critical initialization
    setTimeout(() => {
        try {
            appInstance = new JungleRewardsSystem();
            appInstance.initializeApp();
        } catch (error) {
            console.error('‚ùå Fatal error during app initialization:', error);
            // Emergency fallback
            const loadingScreen = document.getElementById('loadingScreen');
            const appContainer = document.getElementById('app');
            
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (appContainer) appContainer.classList.remove('hidden');
        }
    }, 100);
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (appInstance) {
        appInstance.cleanup();
    }
});

// ========== GLOBAL UTILITY FUNCTIONS ==========

window.switchPage = (page) => {
    if (window.app) {
        window.app.switchPage(page);
    }
};

window.switchView = (view) => {
    if (window.app) {
        window.app.switchView(view);
    }
};
