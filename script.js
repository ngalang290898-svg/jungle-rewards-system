// Complete Student Data
const COMPLETE_DATA = {
  "4 Pearl": {
    "Pre-A1": {
      "ðŸ¯ The Mighty Tigers": {
        totalPoints: 245,
        members: [
          { name: "ADELLA KAISARA BINTI AMDAN", points: 45 },
          { name: "AHMAD JIHAD BIN ABDULLAH", points: 50 },
          { name: "ANJENNY PAILEE", points: 40 },
          { name: "AZIZAH ALISHA BINTI AZMIZAN AZRIN", points: 55 },
          { name: "AZIB ARYAN BIN A.RAHMAN", points: 55 }
        ]
      },
      "ðŸ¼ The Brave Bears": {
        totalPoints: 210,
        members: [
          { name: "GIDEON GALE GARRY", points: 40 },
          { name: "FAREL BIN ARSID", points: 45 },
          { name: "INDRA PUTRA BIN JAINI", points: 35 },
          { name: "MOHAMMAD ABDUL KHALIQ BIN NAISAR", points: 45 },
          { name: "MOHAMAD NUR ZAQIF ZIQRI BIN MOHAMAD TINO", points: 45 }
        ]
      },
      "ðŸ° The Swift Rabbits": {
        totalPoints: 230,
        members: [
          { name: "MUHAMMAD DANISH IFWAT BIN MUHAMMAD IFFAD", points: 50 },
          { name: "MOHAMAD AL HAKIM BIN MOHAMAD RAJAN", points: 45 },
          { name: "MOHAMAD RAID RUZAIMIE BIN MOHD SALIHAN", points: 40 },
          { name: "NUR AIN HAWA SYAKIELA BINTI ILHAM SUKRI", points: 45 },
          { name: "MUHAMMAD IRMANSYAH BIN ABDUL BASIR", points: 50 }
        ]
      }
    },
    "Low A1": {
      "ðŸ¦Š The Clever Foxes": {
        totalPoints: 275,
        members: [
          { name: "MUHAMMAD YUSUF BIN ANNUAR", points: 55 },
          { name: "NOR ZAMIRAH QALISYAH BINTI MOHD ZAMIRUL", points: 60 },
          { name: "MUHAMMAD RAYYAN BIN ARNER", points: 50 },
          { name: "MUHAMMAD AKIF QAIYYUM BIN RANO", points: 55 },
          { name: "MUHAMMAD ASNAWI BIN HAMZAH", points: 55 }
        ]
      }
    },
    "Mid A1": {
      "ðŸ¦… The Brave Eagles": {
        totalPoints: 285,
        members: [
          { name: "NOOR QASEH NADIA BINTI ABDULLAH", points: 60 },
          { name: "MIESYA NUR SYAZIERRA BINTI ISA", points: 55 },
          { name: "MOHAMAD WAN MARZUQI BIN MAZLAN", points: 55 },
          { name: "NOR FATIYYAH FARAHANIE BINTI ZAINI", points: 60 },
          { name: "MUHAMMAD NAZRIN BIN ZULLASRI", points: 55 }
        ]
      },
      "ðŸ† The Swift Panthers": {
        totalPoints: 270,
        members: [
          { name: "MUHAMMAD AL FATIH BIN MOHAMAD FAIZAL AFINDI", points: 55 },
          { name: "NUBHAN BIN JAMIL", points: 50 },
          { name: "NURUL FARAH KHALISYAH BINTI PABIL", points: 55 },
          { name: "NURUL ALISA SAPPIKA BINTI ABDULLAH", points: 55 },
          { name: "MUHAMMAD FAIS BIN HENRAL", points: 55 }
        ]
      }
    },
    "High A1": {
      "ðŸ¦‹ The Shining Butterflies": {
        totalPoints: 330,
        members: [
          { name: "PUTRI ARIESA ZULAIKHA BINTI JUISAL", points: 60 },
          { name: "PUTERI MYA ARLISSA BINTI MOHD BAKRI", points: 55 },
          { name: "MUHAMMAD IRFAN BIN UDAYKUMAR CHOCKALINGAM SHANMUGAM", points: 55 },
          { name: "MUHAMMAD IKMAL BIN RIDSMAR", points: 50 },
          { name: "SYARIF ABDUL HALIM BIN ALNASIR", points: 55 },
          { name: "SITI NUR PUTRI BALQISHAH BINTI MOHD ZALANI", points: 55 }
        ]
      }
    }
  },
  "4 Crystal": {
    "Pre-A1": {
      "ðŸ’ The Playful Monkeys": {
        totalPoints: 405,
        members: [
          { name: "ASHIRAH BINTI ASIS", points: 45 },
          { name: "AIDIL FAZLI BIN ABDULLAH", points: 45 },
          { name: "AL SYAMIR BIN ABDUL NASIR", points: 45 },
          { name: "ELYANA BINTI MARTIN", points: 45 },
          { name: "HAFIZAM AKIM BIN ABDUL AZIS", points: 45 },
          { name: "HAIJAL BIN JAINAL", points: 45 },
          { name: "IMANINA HUSNA BINTI MUHAMMAD SALI", points: 45 },
          { name: "MOHAMMAD HAIKAL HAKIMI BIN ABDULLAH", points: 45 },
          { name: "MOHAMMAD AIREIL DANNISH BIN ASYRAT", points: 45 }
        ]
      },
      "ðŸ¦‰ The Wise Owls": {
        totalPoints: 360,
        members: [
          { name: "MOHAMED DANIEL IMAN BIN BOHARI", points: 45 },
          { name: "MOHAMAD RAIDI SAHRIMAL BIN JAMRI", points: 45 },
          { name: "MUHAMAD AZRUL BIN AZLAN", points: 45 },
          { name: "MUHAMMAD NOOR FAZRIE BIN AMRAN", points: 45 },
          { name: "NUR ARYSA QAISARA BINTI MASRI", points: 45 },
          { name: "NAEL BIN MOHD NIJAR", points: 45 },
          { name: "NIRWANSA BIN RANO", points: 45 },
          { name: "NORAINA BINTI ABDULLAH", points: 45 }
        ]
      },
      "ðŸº The Fearless Wolves": {
        totalPoints: 360,
        members: [
          { name: "NUR PATIAH BINTI ABDULLAH", points: 45 },
          { name: "NUR KHATIJA BINTI IBRAHIM", points: 45 },
          { name: "NURUL HUMAIRA BINTI ASANAL", points: 45 },
          { name: "NAISHA BINTI AZMAN", points: 45 },
          { name: "NUR AFFINA AULIA BINTI RIZAL", points: 45 },
          { name: "MUHAMMAD DANNY ASHRAF BIN ABDULLAH", points: 45 },
          { name: "MUHAMMAD AADAM KHALIF BIN MUHAMMAD HAIRUL NIZAM", points: 45 },
          { name: "NURAISYAH NATASYA BINTI MOHD HANIF WASNI", points: 45 }
        ]
      },
      "ðŸ¦ The Glorious Lions": {
        totalPoints: 495,
        members: [
          { name: "NURAZLIYANAH BATRISHA BINTI SABRI", points: 45 },
          { name: "MOHAMAD RIZANI SYAHIZIEY BIN ABDULLAH", points: 45 },
          { name: "MUHAMMAD HAIZUL BIN OMAR", points: 45 },
          { name: "MUHAMMAD QAWIEM RAFIQ BIN RAZLAN", points: 45 },
          { name: "NUR AZMINA BINTI ABDULLAH", points: 45 },
          { name: "MOHAMMAD SHAZWAN BIN NAZMI", points: 45 },
          { name: "NURUL ALYA ZULAIKHA BINTI SINAKASONI", points: 45 },
          { name: "NURLUTHFIA AZZAHRA BINTI JUWAWI", points: 45 },
          { name: "SITI UMAIRAH BINTI IBRAHIM", points: 45 },
          { name: "WHIRYAN SHAH BIN MOHD NORHISMAL", points: 45 },
          { name: "MUHAMMAD HAFIZ UQASYAH BIN ABDULLAH", points: 45 }
        ]
      }
    }
  }
};

// Main App Class
class JungleRewardsSystem {
  constructor() {
    this.currentClass = '4 Pearl';
    this.currentView = 'visitor';
    this.isAuthenticated = false;
    this.storageKey = 'jungleRewardsData';
    this.currentTheme = 'dark';
    this.loadingTimeout = null;
  }

  // Initialize the application
  initializeApp() {
    console.log('ðŸš€ Initializing Jungle Rewards System...');
    
    try {
      this.initializeData();
      this.initializeTheme();
      
      // Check for existing authentication
      const savedAuth = localStorage.getItem('jungleAuthenticated');
      if (savedAuth === 'true') {
        this.isAuthenticated = true;
        this.toggleAuthState(true);
      }

      this.setupEventListeners();
      this.loadInitialData();
      this.updateQuestProgress();
      
      console.log('âœ… App initialized successfully');
      
    } catch (error) {
      console.error('âŒ Error during app initialization:', error);
      this.showToast('Error initializing app. Please refresh the page.', 'error');
    } finally {
      // Always hide loading screen with fallback
      this.hideLoadingScreen();
    }
  }

  // Initialize data storage
  initializeData() {
    let storedData = localStorage.getItem(this.storageKey);
    
    if (!storedData) {
      localStorage.setItem(this.storageKey, JSON.stringify(COMPLETE_DATA));
      console.log('âœ¨ System initialized with all student data');
    }
  }

  // Initialize theme
  initializeTheme() {
    const savedTheme = localStorage.getItem('jungleTheme') || 'dark';
    this.currentTheme = savedTheme;
    document.documentElement.setAttribute('data-theme', savedTheme);
    this.updateThemeIcon();
  }

  // Setup all event listeners
  setupEventListeners() {
    console.log('ðŸ”§ Setting up event listeners...');

    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const page = e.currentTarget.dataset.page;
        this.switchPage(page);
      });
    });

    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        this.toggleTheme();
      });
    }

    // Class selector
    const classSelector = document.getElementById('classSelector');
    if (classSelector) {
      classSelector.value = this.currentClass;
      classSelector.addEventListener('change', (e) => {
        this.switchClass(e.target.value);
      });
    }

    // Leaderboard class selector
    const leaderboardClassSelector = document.getElementById('leaderboardClassSelector');
    if (leaderboardClassSelector) {
      leaderboardClassSelector.addEventListener('change', (e) => {
        this.loadLeaderboardData(e.target.value);
      });
    }

    // View toggle
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        this.switchView(e.currentTarget.dataset.view);
      });
    });

    // Tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const tab = e.currentTarget.dataset.tab;
        this.switchTab(tab);
      });
    });

    // Login button
    const loginBtn = document.getElementById('loginBtn');
    if (loginBtn) {
      loginBtn.addEventListener('click', () => {
        this.showModal('loginModal');
      });
    }

    // Logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        this.logout();
      });
    }

    // Login form submission
    const submitLogin = document.getElementById('submitLogin');
    const adminPassword = document.getElementById('adminPassword');
    
    if (submitLogin && adminPassword) {
      submitLogin.addEventListener('click', () => {
        const password = adminPassword.value.trim();
        if (password) {
          this.verifyAdminPassword(password);
        } else {
          this.showToast('Please enter password', 'warning');
        }
      });

      adminPassword.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          submitLogin.click();
        }
      });
    }

    // Refresh button
    const refreshBtn = document.getElementById('refreshData');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        this.loadInitialData();
        this.updateQuestProgress();
        this.showToast('Data refreshed', 'success');
      });
    }

    // Admin buttons
    const resetBtn = document.getElementById('resetAllPoints');
    if (resetBtn) {
      resetBtn.addEventListener('click', () => {
        this.resetAllPoints();
      });
    }

    const initBtn = document.getElementById('initializeData');
    if (initBtn) {
      initBtn.addEventListener('click', () => {
        this.initializeSystemData();
      });
    }

    const exportBtn = document.getElementById('exportData');
    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        this.exportData();
      });
    }

    // Teacher overlay
    const teacherTrigger = document.getElementById('teacherOverlayTrigger');
    if (teacherTrigger) {
      teacherTrigger.addEventListener('click', () => {
        this.toggleTeacherOverlay();
      });
    }

    const closeOverlay = document.getElementById('closeTeacherOverlay');
    if (closeOverlay) {
      closeOverlay.addEventListener('click', () => {
        this.hideTeacherOverlay();
      });
    }

    const quickBonus = document.getElementById('overlayQuickBonus');
    if (quickBonus) {
      quickBonus.addEventListener('click', () => {
        this.applyQuickBonus();
      });
    }

    // Modal close buttons
    document.querySelectorAll('.close-modal').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const modal = e.target.closest('.modal');
        if (modal) {
          this.hideModal(modal.id);
        }
      });
    });

    // Close modals on background click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          this.hideModal(modal.id);
        }
      });
    });

    // Page navigation buttons
    document.querySelectorAll('[data-page]').forEach(btn => {
      if (btn.classList.contains('hero-cta-new') || 
          btn.classList.contains('premium-btn') ||
          btn.classList.contains('cta-button-final') ||
          btn.classList.contains('overlay-btn')) {
        btn.addEventListener('click', (e) => {
          const page = e.currentTarget.dataset.page;
          this.switchPage(page);
        });
      }
    });

    // Escape key to close modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        this.hideModal('loginModal');
        this.hideTeacherOverlay();
      }
      
      // Teacher overlay shortcut (Shift + T)
      if (e.shiftKey && e.key === 'T') {
        e.preventDefault();
        this.toggleTeacherOverlay();
      }
    });

    console.log('âœ… Event listeners setup complete');
  }

  // Toggle theme
  toggleTheme() {
    this.currentTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', this.currentTheme);
    localStorage.setItem('jungleTheme', this.currentTheme);
    this.updateThemeIcon();
    this.showToast(`Theme switched to ${this.currentTheme}`, 'info');
  }

  updateThemeIcon() {
    const themeIcon = document.querySelector('#themeToggle i');
    if (themeIcon) {
      themeIcon.className = this.currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }
  }

  // Switch between pages
  switchPage(page) {
    document.querySelectorAll('.page').forEach(p => {
      p.classList.remove('active');
    });

    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
      if (link.dataset.page === page) {
        link.classList.add('active');
      }
    });

    const targetPage = document.getElementById(`${page}Page`);
    if (targetPage) {
      targetPage.classList.add('active');
    }

    // Page-specific initialization
    if (page === 'dashboard') {
      this.loadInitialData();
    } else if (page === 'leaderboard') {
      this.loadLeaderboardData();
    } else if (page === 'home') {
      this.updateQuestProgress();
    }

    this.showToast(`Navigated to ${page.charAt(0).toUpperCase() + page.slice(1)}`, 'info');
  }

  // Switch class
  switchClass(className) {
    this.currentClass = className;
    const classDisplay = document.getElementById('currentClassDisplay');
    if (classDisplay) {
      classDisplay.innerHTML = `<i class="fas fa-graduation-cap"></i> ${className}`;
    }
    
    this.loadInitialData();
    this.updateQuestProgress();
  }

  // Switch view
  switchView(view) {
    this.currentView = view;
    const viewButtons = document.querySelectorAll('.view-btn');
    
    viewButtons.forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.view === view) {
        btn.classList.add('active');
      }
    });

    if (view === 'teacher' && !this.isAuthenticated) {
      this.showModal('loginModal');
    } else {
      this.showToast(`Switched to ${view} view`, 'info');
    }
  }

  // Switch tabs
  switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.tab === tab) {
        btn.classList.add('active');
      }
    });

    document.querySelectorAll('.leaderboard-tab').forEach(tabElement => {
      tabElement.classList.remove('active');
      if (tabElement.id === `${tab}Leaderboard`) {
        tabElement.classList.add('active');
      }
    });

    const classFilter = document.getElementById('leaderboardClassSelector')?.value || 'all';
    if (tab === 'groups') {
      this.loadGroupsLeaderboardData(classFilter);
    } else if (tab === 'individuals') {
      this.loadIndividualsLeaderboardData(classFilter);
    }
  }

  // Scroll to section
  scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
      section.scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
      });
    }
  }

  // Get data from storage
  getData() {
    try {
      const storedData = localStorage.getItem(this.storageKey);
      if (storedData) {
        return JSON.parse(storedData);
      }
    } catch (error) {
      console.warn('LocalStorage read failed, using fallback data');
    }
    
    return JSON.parse(JSON.stringify(COMPLETE_DATA));
  }

  // Save data to storage
  saveData(data) {
    try {
      localStorage.setItem(this.storageKey, JSON.stringify(data));
      return true;
    } catch (error) {
      console.error('LocalStorage write failed:', error);
      this.showToast('Failed to save data.', 'error');
      return false;
    }
  }

  // Load initial data
  loadInitialData() {
    const data = this.getData();
    this.updateGroupsDisplay(data);
    this.updateLastUpdated();
    this.updateSystemStats(data);
  }

  // Update groups display
  updateGroupsDisplay(groupsData) {
    const groupsGrid = document.getElementById('groupsGrid');
    
    if (!groupsGrid) return;

    let html = '';
    let totalGroups = 0;

    for (const [className, levels] of Object.entries(groupsData)) {
      if (className !== this.currentClass) continue;
      
      for (const [level, groups] of Object.entries(levels)) {
        for (const [groupName, groupData] of Object.entries(groups)) {
          totalGroups++;
          
          const groupPoints = groupData.totalPoints || 0;
          const memberCount = groupData.members ? groupData.members.length : 0;
          
          html += `
            <div class="group-card">
              <div class="group-header">
                <div class="group-name">${groupName}</div>
                <div class="group-level">
                  <i class="fas fa-layer-group"></i>
                  ${level} â€¢ ${className}
                </div>
              </div>
              
              <div class="group-stats">
                <div class="points-display">
                  <div class="points-icon">
                    <i class="fas fa-gem"></i>
                  </div>
                  <div class="points-info">
                    <div class="points-value">${groupPoints}</div>
                    <div class="points-label">Crystals</div>
                  </div>
                </div>
                <div class="member-count">
                  <i class="fas fa-users"></i>
                  ${memberCount} members
                </div>
              </div>
              
              <div class="group-actions">
                <button class="group-action-btn view-members" 
                        onclick="app.showGroupMembers('${className}', '${groupName}', '${level}')">
                  <i class="fas fa-list"></i>
                  View Members
                </button>
                ${this.isAuthenticated ? `
                <button class="group-action-btn group-bonus" 
                        onclick="app.applyGroupBonus('${groupName}', '${className}')">
                  <i class="fas fa-star"></i>
                  +10 Bonus
                </button>
                ` : ''}
              </div>
            </div>
          `;
        }
      }
    }

    groupsGrid.innerHTML = html || `
      <div class="loading-groups">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Discovering jungle tribes...</p>
      </div>
    `;
  }

  // Show group members modal
  showGroupMembers(className, groupName, level) {
    const data = this.getData();
    const groupData = data[className]?.[level]?.[groupName];
    
    if (!groupData) {
      this.showToast('Group data not found', 'error');
      return;
    }

    // For now, just show a toast. In a full implementation, this would open a modal.
    this.showToast(`Viewing members of ${groupName}`, 'info');
  }

  // Apply group bonus
  applyGroupBonus(groupName, className) {
    if (!this.isAuthenticated) {
      this.showToast('Please login as teacher first', 'warning');
      return;
    }

    this.showToast(`+10 bonus applied to ${groupName}`, 'success');
  }

  // Update student points
  updateStudentPoints(studentName, pointsChange) {
    if (!this.isAuthenticated) {
      this.showToast('Please login as teacher first', 'warning');
      return;
    }

    this.showToast(`${pointsChange} points updated for ${studentName}`, 'success');
  }

  // Reset all points
  resetAllPoints() {
    if (!this.isAuthenticated) {
      this.showToast('Please login as teacher first', 'warning');
      return;
    }

    if (!confirm('Are you sure you want to reset ALL points to zero?')) {
      return;
    }

    this.showToast('All points have been reset', 'success');
  }

  // Initialize system data
  initializeSystemData() {
    if (!this.isAuthenticated) {
      this.showToast('Please login as teacher first', 'warning');
      return;
    }

    localStorage.removeItem(this.storageKey);
    this.initializeData();
    this.loadInitialData();
    
    this.showToast('System reinitialized with original data', 'success');
  }

  // Export data
  exportData() {
    const data = this.getData();
    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'jungle-rewards-data.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    this.showToast('Data exported successfully', 'success');
  }

  // Update last updated time
  updateLastUpdated() {
    const lastUpdatedElement = document.getElementById('lastUpdated');
    if (lastUpdatedElement) {
      const now = new Date();
      lastUpdatedElement.textContent = `Updated: ${now.toLocaleTimeString()}`;
    }
  }

  // Update system stats
  updateSystemStats(data) {
    const systemStats = document.getElementById('systemStats');
    if (!systemStats) return;

    let totalStudents = 0;
    let totalCrystals = 0;
    let totalGroups = 0;

    for (const [className, levels] of Object.entries(data)) {
      for (const [level, groups] of Object.entries(levels)) {
        for (const [groupName, groupData] of Object.entries(groups)) {
          totalGroups++;
          totalStudents += groupData.members.length;
          totalCrystals += groupData.totalPoints;
        }
      }
    }

    systemStats.innerHTML = `
      <div class="stat-item">
        <i class="fas fa-users"></i>
        <span>Total Students: ${totalStudents}</span>
      </div>
      <div class="stat-item">
        <i class="fas fa-gem"></i>
        <span>Total Crystals: ${totalCrystals}</span>
      </div>
      <div class="stat-item">
        <i class="fas fa-layer-group"></i>
        <span>Active Groups: ${totalGroups}</span>
      </div>
    `;
  }

  // Update quest progress
  updateQuestProgress() {
    const totalCrystals = this.calculateClassTotal();
    const milestones = [
      { points: 20, name: "Waterfall" },
      { points: 40, name: "Ancient Temple" },
      { points: 60, name: "Jungle Friends" },
      { points: 100, name: "Jungle Champion" }
    ];

    const nextMilestone = this.getNextMilestone(totalCrystals, milestones);
    const progressPercent = Math.min(100, (totalCrystals / nextMilestone.points) * 100);

    // Update display elements
    const currentCrystals = document.getElementById('currentCrystals');
    const nextMilestoneEl = document.getElementById('nextMilestone');
    const progressPercentEl = document.getElementById('progressPercent');
    const questProgressFill = document.getElementById('questProgressFill');

    if (currentCrystals) currentCrystals.textContent = totalCrystals;
    if (nextMilestoneEl) nextMilestoneEl.textContent = nextMilestone.points;
    if (progressPercentEl) progressPercentEl.textContent = `${Math.round(progressPercent)}%`;
    if (questProgressFill) questProgressFill.style.width = `${progressPercent}%`;

    // Update mascot message
    this.updateMascotMessage(totalCrystals, milestones);

    // Update milestone unlocks
    this.updateMilestoneUnlocks(totalCrystals, milestones);
  }

  // Calculate total crystals for current class
  calculateClassTotal() {
    const data = this.getData();
    const currentClass = this.currentClass;
    let totalCrystals = 0;

    if (data[currentClass]) {
      for (const level of Object.values(data[currentClass])) {
        for (const group of Object.values(level)) {
          totalCrystals += group.totalPoints || 0;
        }
      }
    }

    return totalCrystals;
  }

  // Get next milestone
  getNextMilestone(currentPoints, milestones) {
    for (const milestone of milestones) {
      if (currentPoints < milestone.points) {
        return milestone;
      }
    }
    return milestones[milestones.length - 1];
  }

  // Update mascot message
  updateMascotMessage(currentPoints, milestones) {
    const mascotMessage = document.getElementById('mascotMessage');
    if (!mascotMessage) return;
    
    let achievedMilestone = null;
    for (const milestone of milestones) {
      if (currentPoints >= milestone.points) {
        achievedMilestone = milestone;
      }
    }

    if (achievedMilestone && currentPoints === achievedMilestone.points) {
      mascotMessage.textContent = `Great! You've reached the ${achievedMilestone.name}!`;
    } else if (achievedMilestone) {
      const nextMilestone = this.getNextMilestone(currentPoints, milestones);
      mascotMessage.textContent = `You've unlocked ${achievedMilestone.name}! Next: ${nextMilestone.name} at ${nextMilestone.points} crystals.`;
    } else {
      const firstMilestone = milestones[0];
      mascotMessage.textContent = `Let's start our adventure! Earn ${firstMilestone.points} crystals to reach the ${firstMilestone.name}.`;
    }
  }

  // Update milestone unlocks
  updateMilestoneUnlocks(currentPoints, milestones) {
    const milestoneElements = document.querySelectorAll('.milestone');
    
    milestoneElements.forEach((milestone, index) => {
      const milestonePoints = milestones[index].points;
      
      if (currentPoints >= milestonePoints) {
        milestone.classList.add('unlocked');
      } else {
        milestone.classList.remove('unlocked');
      }
    });
  }

  // Teacher overlay functions
  toggleTeacherOverlay() {
    const overlay = document.getElementById('teacherOverlay');
    if (overlay && overlay.classList.contains('hidden')) {
      this.showTeacherOverlay();
    } else {
      this.hideTeacherOverlay();
    }
  }

  showTeacherOverlay() {
    const overlay = document.getElementById('teacherOverlay');
    if (overlay) {
      overlay.classList.remove('hidden');
      this.updateTeacherOverlayStats();
    }
  }

  hideTeacherOverlay() {
    const overlay = document.getElementById('teacherOverlay');
    if (overlay) {
      overlay.classList.add('hidden');
    }
  }

  updateTeacherOverlayStats() {
    const data = this.getData();
    let totalPoints = 0;
    let totalStudents = 0;

    for (const [className, levels] of Object.entries(data)) {
      for (const [level, groups] of Object.entries(levels)) {
        for (const [groupName, groupData] of Object.entries(groups)) {
          totalPoints += groupData.totalPoints || 0;
          totalStudents += groupData.members ? groupData.members.length : 0;
        }
      }
    }

    const totalPointsEl = document.getElementById('overlayTotalPoints');
    const activeStudentsEl = document.getElementById('overlayActiveStudents');

    if (totalPointsEl) totalPointsEl.textContent = totalPoints;
    if (activeStudentsEl) activeStudentsEl.textContent = totalStudents;
  }

  applyQuickBonus() {
    if (!this.isAuthenticated) {
      this.showToast('Please login as teacher first', 'warning');
      return;
    }

    this.showToast('Quick bonus applied to all students!', 'success');
  }

  // Authentication functions
  verifyAdminPassword(password) {
    if (password === 'jungle123') {
      this.isAuthenticated = true;
      localStorage.setItem('jungleAuthenticated', 'true');
      this.toggleAuthState(true);
      this.showToast('Admin access granted!', 'success');
      this.hideModal('loginModal');
      return true;
    } else {
      this.showToast('Invalid password', 'error');
      return false;
    }
  }

  logout() {
    this.isAuthenticated = false;
    localStorage.removeItem('jungleAuthenticated');
    this.toggleAuthState(false);
    this.showToast('Logged out successfully', 'info');
  }

  toggleAuthState(isAuthenticated) {
    const adminElements = document.querySelectorAll('.admin-only');
    const teacherTrigger = document.getElementById('teacherOverlayTrigger');
    
    adminElements.forEach(el => {
      if (isAuthenticated) {
        el.classList.remove('hidden');
      } else {
        el.classList.add('hidden');
      }
    });

    if (teacherTrigger) {
      if (isAuthenticated) {
        teacherTrigger.classList.remove('hidden');
      } else {
        teacherTrigger.classList.add('hidden');
      }
    }

    if (isAuthenticated) {
      this.showToast('Teacher mode activated', 'success');
    }
  }

  // Leaderboard functions
  loadLeaderboardData(classFilter = 'all') {
    this.loadGroupsLeaderboardData(classFilter);
    this.loadIndividualsLeaderboardData(classFilter);
  }

  loadGroupsLeaderboardData(classFilter = 'all') {
    const groupsContent = document.getElementById('groupsLeaderboardContent');
    if (!groupsContent) return;

    const data = this.getData();
    let groupsList = [];

    for (const [className, levels] of Object.entries(data)) {
      if (classFilter !== 'all' && className !== classFilter) continue;
      
      for (const [level, groups] of Object.entries(levels)) {
        for (const [groupName, groupData] of Object.entries(groups)) {
          groupsList.push({
            name: groupName,
            class: className,
            level: level,
            points: groupData.totalPoints || 0,
            members: groupData.members ? groupData.members.length : 0
          });
        }
      }
    }

    groupsList.sort((a, b) => b.points - a.points);

    let groupsHtml = '';
    groupsList.forEach((group, index) => {
      const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : '';
      
      groupsHtml += `
        <div class="leaderboard-item">
          <div class="rank">${medal} ${index + 1}</div>
          <div class="leaderboard-info">
            <div class="leaderboard-name">
              ${group.name}
              <span class="group-badge">${group.class}</span>
            </div>
            <div class="leaderboard-meta">
              ${group.level} â€¢ ${group.members} members
            </div>
          </div>
          <div class="leaderboard-points">
            ${group.points}
          </div>
        </div>
      `;
    });

    groupsContent.innerHTML = groupsHtml || '<div class="loading-leaderboard"><p>No group data found</p></div>';
  }

  loadIndividualsLeaderboardData(classFilter = 'all') {
    const individualsContent = document.getElementById('individualsLeaderboardContent');
    if (!individualsContent) return;

    const data = this.getData();
    let allStudents = [];

    for (const [className, levels] of Object.entries(data)) {
      if (classFilter !== 'all' && className !== classFilter) continue;
      
      for (const [level, groups] of Object.entries(levels)) {
        for (const [groupName, groupData] of Object.entries(groups)) {
          groupData.members.forEach(student => {
            allStudents.push({
              name: student.name,
              points: student.points || 0,
              class: className,
              group: groupName,
              level: level
            });
          });
        }
      }
    }

    allStudents.sort((a, b) => b.points - a.points);

    let individualsHtml = '';
    if (allStudents.length > 0) {
      allStudents.forEach((student, index) => {
        const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : '';
        
        individualsHtml += `
          <div class="leaderboard-item">
            <div class="rank">${medal} ${index + 1}</div>
            <div class="leaderboard-info">
              <div class="leaderboard-name">
                ${student.name}
                <span class="group-badge">${student.group}</span>
              </div>
              <div class="leaderboard-meta">
                ${student.class} â€¢ ${student.level}
              </div>
            </div>
            <div class="leaderboard-points">
              ${student.points}
            </div>
          </div>
        `;
      });
    } else {
      individualsHtml = '<div class="loading-leaderboard"><p>No student data found</p></div>';
    }

    individualsContent.innerHTML = individualsHtml;
  }

  // Modal functions
  showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove('hidden');
    }
  }

  hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add('hidden');
    }
  }

  // Toast notification system
  showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <div class="toast-icon">
        <i class="fas fa-${this.getToastIcon(type)}"></i>
      </div>
      <div class="toast-message">${message}</div>
      <button class="toast-close" onclick="this.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
    `;

    container.appendChild(toast);

    setTimeout(() => {
      if (toast.parentElement) {
        toast.remove();
      }
    }, 5000);
  }

  getToastIcon(type) {
    const icons = {
      success: 'check-circle',
      error: 'exclamation-triangle',
      warning: 'exclamation-circle',
      info: 'info-circle'
    };
    return icons[type] || 'info-circle';
  }

  // Loading screen - FIXED VERSION
  hideLoadingScreen() {
    console.log('ðŸŽ¬ Hiding loading screen...');
    
    const loadingScreen = document.getElementById('loadingScreen');
    const appContainer = document.getElementById('app');
    
    if (loadingScreen && appContainer) {
      // Clear any existing timeout
      if (this.loadingTimeout) {
        clearTimeout(this.loadingTimeout);
      }
      
      // Set a fallback timeout to ensure loading screen hides
      this.loadingTimeout = setTimeout(() => {
        console.log('â° Fallback: Force hiding loading screen');
        if (loadingScreen.style.display !== 'none') {
          loadingScreen.style.display = 'none';
          appContainer.classList.remove('hidden');
          this.showToast('Welcome to the Magical Jungle! ðŸŒ¿', 'success');
        }
      }, 3000); // 3 second fallback
      
      // Try to hide normally first
      try {
        appContainer.classList.remove('hidden');
        
        // Add fade out animation
        loadingScreen.style.opacity = '0';
        loadingScreen.style.transition = 'opacity 0.5s ease';
        
        setTimeout(() => {
          loadingScreen.style.display = 'none';
          console.log('âœ… Loading screen hidden successfully');
          this.showToast('Welcome to the Magical Jungle! ðŸŒ¿', 'success');
          
          // Clear the fallback timeout since we succeeded
          if (this.loadingTimeout) {
            clearTimeout(this.loadingTimeout);
          }
        }, 500);
        
      } catch (error) {
        console.error('âŒ Error hiding loading screen:', error);
        // Fallback will handle it
      }
    } else {
      console.error('âŒ Could not find loading screen or app container');
      // Emergency fallback
      setTimeout(() => {
        if (appContainer) appContainer.classList.remove('hidden');
        if (loadingScreen) loadingScreen.style.display = 'none';
      }, 1000);
    }
  }

  // Reward animations
  playConfetti() {
    // Simple confetti effect implementation
    this.showToast('ðŸŽ‰ Celebration!', 'success');
  }

  showRewardAnimation(message, points = 0) {
    this.showToast(`${message} ${points ? `+${points} points` : ''}`, 'success');
  }
}

// Initialize the application
let app;

document.addEventListener('DOMContentLoaded', () => {
  console.log('ðŸŒ¿ DOM loaded - initializing Jungle Rewards System');
  
  // Add a safety timeout to ensure the app loads even if there are issues
  const safetyTimeout = setTimeout(() => {
    const loadingScreen = document.getElementById('loadingScreen');
    const appContainer = document.getElementById('app');
    
    if (loadingScreen && loadingScreen.style.display !== 'none') {
      console.log('ðŸ†˜ Safety timeout triggered - forcing app to show');
      loadingScreen.style.display = 'none';
      if (appContainer) appContainer.classList.remove('hidden');
    }
  }, 5000); // 5 second absolute maximum
  
  try {
    app = new JungleRewardsSystem();
    app.initializeApp();
    
    // Clear safety timeout if app initializes successfully
    clearTimeout(safetyTimeout);
  } catch (error) {
    console.error('âŒ Fatal error during app initialization:', error);
    
    // Emergency recovery
    const loadingScreen = document.getElementById('loadingScreen');
    const appContainer = document.getElementById('app');
    
    if (loadingScreen) loadingScreen.style.display = 'none';
    if (appContainer) appContainer.classList.remove('hidden');
    
    clearTimeout(safetyTimeout);
  }
});

// Global functions for HTML onclick handlers
window.app = window.app || {};

window.switchPage = (page) => {
  if (app) {
    app.switchPage(page);
  }
};

window.scrollToSection = (sectionId) => {
  if (app) {
    app.scrollToSection(sectionId);
  }
};
