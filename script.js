// Complete Student Data - All 72 Students
const COMPLETE_DATA = {
  "4 Pearl": {
    "Pre-A1": {
      "üêØ The Mighty Tigers": {
        totalPoints: 245,
        members: [
          { name: "ADELLA KAISARA BINTI AMDAN", points: 45 },
          { name: "AHMAD JIHAD BIN ABDULLAH", points: 50 },
          { name: "ANJENNY PAILEE", points: 40 },
          { name: "AZIZAH ALISHA BINTI AZMIZAN AZRIN", points: 55 },
          { name: "AZIB ARYAN BIN A.RAHMAN", points: 55 }
        ]
      },
      "üêº The Brave Bears": {
        totalPoints: 210,
        members: [
          { name: "GIDEON GALE GARRY", points: 40 },
          { name: "FAREL BIN ARSID", points: 45 },
          { name: "INDRA PUTRA BIN JAINI", points: 35 },
          { name: "MOHAMMAD ABDUL KHALIQ BIN NAISAR", points: 45 },
          { name: "MOHAMAD NUR ZAQIF ZIQRI BIN MOHAMAD TINO", points: 45 }
        ]
      },
      "üê∞ The Swift Rabbits": {
        totalPoints: 230,
        members: [
          { name: "MUHAMMAD DANISH IFWAT BIN MUHAMMAD IFFAD", points: 50 },
          { name: "MOHAMAD AL HAKIM BIN MOHAMAD RAJAN", points: 45 },
          { name: "MOHAMAD RAID RUZAIMIE BIN MOHD SALIHAN", points: 40 },
          { name: "NUR AIN HAWA SYAKIELA BINTI ILHAM SUKRI", points: 45 },
          { name: "MUHAMMAD IRMANSYAH BIN ABDUL BASIR", points: 50 }
        ]
      }
    },
    "Low A1": {
      "ü¶ä The Clever Foxes": {
        totalPoints: 275,
        members: [
          { name: "MUHAMMAD YUSUF BIN ANNUAR", points: 55 },
          { name: "NOR ZAMIRAH QALISYAH BINTI MOHD ZAMIRUL", points: 60 },
          { name: "MUHAMMAD RAYYAN BIN ARNER", points: 50 },
          { name: "MUHAMMAD AKIF QAIYYUM BIN RANO", points: 55 },
          { name: "MUHAMMAD ASNAWI BIN HAMZAH", points: 55 }
        ]
      }
    },
    "Mid A1": {
      "ü¶Ö The Brave Eagles": {
        totalPoints: 285,
        members: [
          { name: "NOOR QASEH NADIA BINTI ABDULLAH", points: 60 },
          { name: "MIESYA NUR SYAZIERRA BINTI ISA", points: 55 },
          { name: "MOHAMAD WAN MARZUQI BIN MAZLAN", points: 55 },
          { name: "NOR FATIYYAH FARAHANIE BINTI ZAINI", points: 60 },
          { name: "MUHAMMAD NAZRIN BIN ZULLASRI", points: 55 }
        ]
      },
      "üêÜ The Swift Panthers": {
        totalPoints: 270,
        members: [
          { name: "MUHAMMAD AL FATIH BIN MOHAMAD FAIZAL AFINDI", points: 55 },
          { name: "NUBHAN BIN JAMIL", points: 50 },
          { name: "NURUL FARAH KHALISYAH BINTI PABIL", points: 55 },
          { name: "NURUL ALISA SAPPIKA BINTI ABDULLAH", points: 55 },
          { name: "MUHAMMAD FAIS BIN HENRAL", points: 55 }
        ]
      }
    },
    "High A1": {
      "ü¶ã The Shining Butterflies": {
        totalPoints: 330,
        members: [
          { name: "PUTRI ARIESA ZULAIKHA BINTI JUISAL", points: 60 },
          { name: "PUTERI MYA ARLISSA BINTI MOHD BAKRI", points: 55 },
          { name: "MUHAMMAD IRFAN BIN UDAYKUMAR CHOCKALINGAM SHANMUGAM", points: 55 },
          { name: "MUHAMMAD IKMAL BIN RIDSMAR", points: 50 },
          { name: "SYARIF ABDUL HALIM BIN ALNASIR", points: 55 },
          { name: "SITI NUR PUTRI BALQISHAH BINTI MOHD ZALANI", points: 55 }
        ]
      }
    }
  },
  "4 Crystal": {
    "Pre-A1": {
      "üêí The Playful Monkeys": {
        totalPoints: 405,
        members: [
          { name: "ASHIRAH BINTI ASIS", points: 45 },
          { name: "AIDIL FAZLI BIN ABDULLAH", points: 45 },
          { name: "AL SYAMIR BIN ABDUL NASIR", points: 45 },
          { name: "ELYANA BINTI MARTIN", points: 45 },
          { name: "HAFIZAM AKIM BIN ABDUL AZIS", points: 45 },
          { name: "HAIJAL BIN JAINAL", points: 45 },
          { name: "IMANINA HUSNA BINTI MUHAMMAD SALI", points: 45 },
          { name: "MOHAMMAD HAIKAL HAKIMI BIN ABDULLAH", points: 45 },
          { name: "MOHAMMAD AIREIL DANNISH BIN ASYRAT", points: 45 }
        ]
      },
      "ü¶â The Wise Owls": {
        totalPoints: 360,
        members: [
          { name: "MOHAMED DANIEL IMAN BIN BOHARI", points: 45 },
          { name: "MOHAMAD RAIDI SAHRIMAL BIN JAMRI", points: 45 },
          { name: "MUHAMAD AZRUL BIN AZLAN", points: 45 },
          { name: "MUHAMMAD NOOR FAZRIE BIN AMRAN", points: 45 },
          { name: "NUR ARYSA QAISARA BINTI MASRI", points: 45 },
          { name: "NAEL BIN MOHD NIJAR", points: 45 },
          { name: "NIRWANSA BIN RANO", points: 45 },
          { name: "NORAINA BINTI ABDULLAH", points: 45 }
        ]
      },
      "üê∫ The Fearless Wolves": {
        totalPoints: 360,
        members: [
          { name: "NUR PATIAH BINTI ABDULLAH", points: 45 },
          { name: "NUR KHATIJA BINTI IBRAHIM", points: 45 },
          { name: "NURUL HUMAIRA BINTI ASANAL", points: 45 },
          { name: "NAISHA BINTI AZMAN", points: 45 },
          { name: "NUR AFFINA AULIA BINTI RIZAL", points: 45 },
          { name: "MUHAMMAD DANNY ASHRAF BIN ABDULLAH", points: 45 },
          { name: "MUHAMMAD AADAM KHALIF BIN MUHAMMAD HAIRUL NIZAM", points: 45 },
          { name: "NURAISYAH NATASYA BINTI MOHD HANIF WASNI", points: 45 }
        ]
      },
      "ü¶Å The Glorious Lions": {
        totalPoints: 495,
        members: [
          { name: "NURAZLIYANAH BATRISHA BINTI SABRI", points: 45 },
          { name: "MOHAMAD RIZANI SYAHIZIEY BIN ABDULLAH", points: 45 },
          { name: "MUHAMMAD HAIZUL BIN OMAR", points: 45 },
          { name: "MUHAMMAD QAWIEM RAFIQ BIN RAZLAN", points: 45 },
          { name: "NUR AZMINA BINTI ABDULLAH", points: 45 },
          { name: "MOHAMMAD SHAZWAN BIN NAZMI", points: 45 },
          { name: "NURUL ALYA ZULAIKHA BINTI SINAKASONI", points: 45 },
          { name: "NURLUTHFIA AZZAHRA BINTI JUWAWI", points: 45 },
          { name: "SITI UMAIRAH BINTI IBRAHIM", points: 45 },
          { name: "WHIRYAN SHAH BIN MOHD NORHISMAL", points: 45 },
          { name: "MUHAMMAD HAFIZ UQASYAH BIN ABDULLAH", points: 45 }
        ]
      }
    }
  }
};

// ========== MASCOT & QUEST SYSTEM ==========

class MascotQuestSystem {
  constructor(app) {
    this.app = app;
    this.milestones = [
      { points: 20, name: "Waterfall", message: "Great start! You've reached the magical waterfall. Keep going!" },
      { points: 40, name: "Ancient Temple", message: "Amazing! You discovered the ancient temple. Your English is getting stronger!" },
      { points: 60, name: "Jungle Friends", message: "Fantastic! You've made new jungle friends. They're cheering for you!" },
      { points: 100, name: "Jungle Champion", message: "Incredible! You're a true Jungle Champion! üèÜ Your English skills are shining!" }
    ];
  }

  /**
   * Calculate total crystals for current class
   */
  calculateClassTotal() {
    const data = this.app.getData();
    const currentClass = this.app.currentClass;
    let totalCrystals = 0;

    if (data[currentClass]) {
      for (const level of Object.values(data[currentClass])) {
        for (const group of Object.values(level)) {
          totalCrystals += group.totalPoints || 0;
        }
      }
    }

    return totalCrystals;
  }

  /**
   * Update quest progress display
   */
  updateQuestProgress() {
    const totalCrystals = this.calculateClassTotal();
    const nextMilestone = this.getNextMilestone(totalCrystals);
    const progressPercent = Math.min(100, (totalCrystals / nextMilestone.points) * 100);

    // Update display elements
    document.getElementById('currentCrystals').textContent = totalCrystals;
    document.getElementById('nextMilestone').textContent = nextMilestone.points;
    document.getElementById('progressPercent').textContent = `${Math.round(progressPercent)}%`;
    document.getElementById('questProgressFill').style.width = `${progressPercent}%`;

    // Update mascot message
    this.updateMascotMessage(totalCrystals);

    // Update milestone unlocks
    this.updateMilestoneUnlocks(totalCrystals);
  }

  /**
   * Get the next milestone to achieve
   */
  getNextMilestone(currentPoints) {
    for (const milestone of this.milestones) {
      if (currentPoints < milestone.points) {
        return milestone;
      }
    }
    // If all milestones achieved, return the last one
    return this.milestones[this.milestones.length - 1];
  }

  /**
   * Update mascot speech bubble with appropriate message
   */
  updateMascotMessage(currentPoints) {
    const mascotMessage = document.getElementById('mascotMessage');
    
    // Find the highest achieved milestone
    let achievedMilestone = null;
    for (const milestone of this.milestones) {
      if (currentPoints >= milestone.points) {
        achievedMilestone = milestone;
      }
    }

    if (achievedMilestone && currentPoints === achievedMilestone.points) {
      // Just reached a milestone
      mascotMessage.textContent = achievedMilestone.message;
      this.celebrateMilestone(achievedMilestone.name);
    } else if (achievedMilestone) {
      // Passed a milestone
      const nextMilestone = this.getNextMilestone(currentPoints);
      mascotMessage.textContent = `You've unlocked ${achievedMilestone.name}! Next stop: ${nextMilestone.name} at ${nextMilestone.points} crystals.`;
    } else {
      // No milestones yet
      const firstMilestone = this.milestones[0];
      mascotMessage.textContent = `Let's start our jungle adventure! Earn ${firstMilestone.points} crystals to reach the ${firstMilestone.name}.`;
    }
  }

  /**
   * Update visual milestone unlocks
   */
  updateMilestoneUnlocks(currentPoints) {
    const milestones = document.querySelectorAll('.milestone');
    
    milestones.forEach((milestone, index) => {
      const milestonePoints = this.milestones[index].points;
      
      if (currentPoints >= milestonePoints) {
        milestone.classList.add('unlocked');
      } else {
        milestone.classList.remove('unlocked');
      }
    });
  }

  /**
   * Celebrate milestone achievement
   */
  celebrateMilestone(milestoneName) {
    this.app.showRewardAnimation(`üéâ Unlocked: ${milestoneName}!`, 0);
    this.app.playConfetti();
    this.app.showToast(`üèÜ Amazing! You've unlocked ${milestoneName}!`, 'success');
  }

  /**
   * Initialize the quest system
   */
  initialize() {
    this.updateQuestProgress();
    
    // Update when class changes
    const classSelector = document.getElementById('classSelector');
    if (classSelector) {
      classSelector.addEventListener('change', () => {
        setTimeout(() => this.updateQuestProgress(), 100);
      });
    }
  }
}

// ========== TEACHER ADMIN OVERLAY ==========

class TeacherOverlay {
  constructor(app) {
    this.app = app;
    this.isVisible = false;
  }

  /**
   * Initialize teacher overlay
   */
  initialize() {
    this.createOverlayTrigger();
    this.setupKeyboardShortcut();
    this.setupOverlayEvents();
  }

  /**
   * Create floating trigger button
   */
  createOverlayTrigger() {
    // Button is already in HTML, just set up events
    const trigger = document.getElementById('teacherOverlayTrigger');
    const overlay = document.getElementById('teacherOverlay');
    const closeBtn = document.getElementById('closeTeacherOverlay');

    if (trigger) {
      trigger.addEventListener('click', () => this.toggleOverlay());
    }

    if (closeBtn) {
      closeBtn.addEventListener('click', () => this.hideOverlay());
    }

    if (overlay) {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          this.hideOverlay();
        }
      });
    }

    // Set up overlay button actions
    this.setupOverlayActions();
  }

  /**
   * Setup keyboard shortcut (Shift + T)
   */
  setupKeyboardShortcut() {
    document.addEventListener('keydown', (e) => {
      if (e.shiftKey && e.key === 'T') {
        e.preventDefault();
        this.toggleOverlay();
      }
    });
  }

  /**
   * Setup overlay events and actions
   */
  setupOverlayEvents() {
    // Update overlay stats when shown
    const overlay = document.getElementById('teacherOverlay');
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          if (!overlay.classList.contains('hidden')) {
            this.updateOverlayStats();
          }
        }
      });
    });

    observer.observe(overlay, { attributes: true });
  }

  /**
   * Setup overlay button actions
   */
  setupOverlayActions() {
    // Page navigation buttons
    document.querySelectorAll('.overlay-btn[data-page]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const page = e.currentTarget.dataset.page;
        this.app.switchPage(page);
        this.hideOverlay();
      });
    });

    // Quick bonus button
    const quickBonusBtn = document.getElementById('overlayQuickBonus');
    if (quickBonusBtn) {
      quickBonusBtn.addEventListener('click', () => {
        this.applyQuickBonus();
      });
    }
  }

  /**
   * Toggle overlay visibility
   */
  toggleOverlay() {
    const overlay = document.getElementById('teacherOverlay');
    if (overlay.classList.contains('hidden')) {
      this.showOverlay();
    } else {
      this.hideOverlay();
    }
  }

  /**
   * Show teacher overlay
   */
  showOverlay() {
    const overlay = document.getElementById('teacherOverlay');
    overlay.classList.remove('hidden');
    this.isVisible = true;
    this.updateOverlayStats();
  }

  /**
   * Hide teacher overlay
   */
  hideOverlay() {
    const overlay = document.getElementById('teacherOverlay');
    overlay.classList.add('hidden');
    this.isVisible = false;
  }

  /**
   * Update overlay statistics
   */
  updateOverlayStats() {
    const data = this.app.getData();
    let totalPoints = 0;
    let totalStudents = 0;

    for (const [className, levels] of Object.entries(data)) {
      for (const [level, groups] of Object.entries(levels)) {
        for (const [groupName, groupData] of Object.entries(groups)) {
          totalPoints += groupData.totalPoints || 0;
          totalStudents += groupData.members ? groupData.members.length : 0;
        }
      }
    }

    document.getElementById('overlayTotalPoints').textContent = totalPoints;
    document.getElementById('overlayActiveStudents').textContent = totalStudents;
  }

  /**
   * Apply quick bonus to all students in current class
   */
  applyQuickBonus() {
    if (!this.app.isAuthenticated) {
      this.app.showToast('Please login as teacher first', 'warning');
      return;
    }

    const data = this.app.getData();
    const currentClass = this.app.currentClass;
    let bonusCount = 0;

    if (data[currentClass]) {
      for (const [level, groups] of Object.entries(data[currentClass])) {
        for (const [groupName, groupData] of Object.entries(groups)) {
          groupData.members.forEach(student => {
            student.points += 5; // +5 bonus points
            bonusCount++;
          });
          groupData.totalPoints = groupData.members.reduce((sum, s) => sum + s.points, 0);
        }
      }
    }

    this.app.saveData(data);
    this.app.loadInitialData();
    
    this.app.showRewardAnimation('Quick Bonus Applied! +5 to all students', 5);
    this.app.playConfetti();
    this.app.showToast(`üéâ +5 points bonus applied to ${bonusCount} students`, 'success');
    
    this.hideOverlay();
  }
}

// ========== ENHANCED JUNGLE REWARDS SYSTEM ==========

class JungleRewardsSystem {
    constructor() {
        this.currentClass = '4 Pearl';
        this.currentView = 'visitor';
        this.isAuthenticated = false;
        this.storageKey = 'jungleRewardsData';
        this.currentTheme = 'dark';
        this.initialized = false;
        this.animationFrameId = null;
        
        // Initialize new systems
        this.mascotQuestSystem = new MascotQuestSystem(this);
        this.teacherOverlay = new TeacherOverlay(this);
        
        // Performance monitoring
        this.lowPerformanceMode = this.detectLowPerformance();
    }

    // ========== INITIALIZATION ==========
    
    /**
     * Main app initialization with error handling
     */
    initializeApp() {
        console.log('üöÄ Initializing Enhanced Jungle Rewards System...');
        
        try {
            this.initializeData();
            this.initializeTheme();
            this.initializeBackground();
            
            // Check for existing authentication
            const savedAuth = localStorage.getItem('jungleAuthenticated');
            if (savedAuth === 'true') {
                this.isAuthenticated = true;
                this.toggleAuthState(true);
            }

            this.loadInitialData();
            this.setupEventListeners();
            
            // Initialize new systems
            this.mascotQuestSystem.initialize();
            this.teacherOverlay.initialize();
            
            // Load homepage specific data
            this.loadTopTeams();
            
            console.log('‚úÖ App initialized successfully');
            this.initialized = true;
            
        } catch (error) {
            console.error('‚ùå Error during app initialization:', error);
            this.showToast('Error initializing app. Please refresh the page.', 'error');
        } finally {
            // Always hide loading screen, even if there's an error
            this.hideLoadingScreen();
        }
    }

    // ========== EXISTING METHODS (with minor updates) ==========
    
    initializeData() {
        let storedData = localStorage.getItem(this.storageKey);
        
        if (!storedData) {
            localStorage.setItem(this.storageKey, JSON.stringify(COMPLETE_DATA));
            console.log('‚ú® System initialized with all student data');
        }
    }

    initializeTheme() {
        const savedTheme = localStorage.getItem('jungleTheme') || 'dark';
        this.currentTheme = savedTheme;
        document.documentElement.setAttribute('data-theme', savedTheme);
        this.updateThemeIcon();
    }

    detectLowPerformance() {
        const hasLowMemory = navigator.deviceMemory && navigator.deviceMemory < 4;
        const hasLowCores = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 2;
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        return hasLowMemory || hasLowCores || isMobile;
    }

    initializeBackground() {
        if (this.lowPerformanceMode) {
            console.log('üöÄ Using lightweight background for better performance');
            this.setupParticleBackground();
            return;
        }
        
        if (window.THREE) {
            this.setupWebGLBackground();
        } else {
            this.setupParticleBackground();
        }
    }

    // ========== NEW PAGE MANAGEMENT ==========
    
    /**
     * Enhanced page switching to handle new pages
     */
    switchPage(page) {
        document.querySelectorAll('.page').forEach(p => {
            p.classList.remove('active');
        });

        const targetPage = document.getElementById(`${page}Page`);
        if (targetPage) {
            targetPage.classList.add('active');
        }

        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.dataset.page === page) {
                link.classList.add('active');
            }
        });

        // Page-specific initialization
        if (page === 'dashboard') {
            this.loadInitialData();
        } else if (page === 'leaderboard') {
            this.loadLeaderboardData();
        } else if (page === 'home') {
            this.loadTopTeams();
            this.mascotQuestSystem.updateQuestProgress();
        } else if (page === 'rewards') {
            // Initialize rewards page if needed
            console.log('üì¶ Rewards page loaded');
        }

        this.showToast(`Navigated to ${page.charAt(0).toUpperCase() + page.slice(1)}`, 'info');
    }

    // ========== UPDATED EVENT LISTENERS ==========
    
    /**
     * Enhanced event listener setup
     */
    setupEventListeners() {
        console.log('üîß Setting up enhanced event listeners...');
        
        const safeQuery = (selector, context = document) => {
            const element = context.querySelector(selector);
            if (!element) {
                console.warn(`Element not found: ${selector}`);
            }
            return element;
        };

        try {
            // Enhanced navigation with new pages
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = e.currentTarget.dataset.page;
                    this.switchPage(page);
                });
                
                link.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        link.click();
                    }
                });
            });

            // Theme toggle
            const themeToggle = safeQuery('#themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    this.toggleTheme();
                });
            }

            // Class selector with quest updates
            const classSelector = safeQuery('#classSelector');
            if (classSelector) {
                classSelector.value = this.currentClass;
                classSelector.addEventListener('change', (e) => {
                    this.switchClass(e.target.value);
                    // Update quest progress when class changes
                    setTimeout(() => this.mascotQuestSystem.updateQuestProgress(), 100);
                });
            }

            // Leaderboard class selector
            const leaderboardClassSelector = safeQuery('#leaderboardClassSelector');
            if (leaderboardClassSelector) {
                leaderboardClassSelector.addEventListener('change', (e) => {
                    this.loadLeaderboardData(e.target.value);
                });
            }

            // View toggle
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    this.switchView(e.currentTarget.dataset.view);
                });
            });

            // Tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tab = e.currentTarget.dataset.tab;
                    this.switchTab(tab);
                });
                
                btn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });
            });

            // Login button
            const loginBtn = safeQuery('#loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    this.showModal('loginModal');
                });
            }

            // Logout button
            const logoutBtn = safeQuery('#logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    this.logout();
                });
            }

            // Login form submission
            const submitLogin = safeQuery('#submitLogin');
            const adminPassword = safeQuery('#adminPassword');
            
            if (submitLogin && adminPassword) {
                submitLogin.addEventListener('click', () => {
                    const password = adminPassword.value.trim();
                    if (password) {
                        this.verifyAdminPassword(password);
                    } else {
                        this.showToast('Please enter password', 'warning');
                    }
                });

                adminPassword.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitLogin.click();
                    }
                });
            }

            // Refresh button
            const refreshBtn = safeQuery('#refreshData');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    this.loadInitialData();
                    this.mascotQuestSystem.updateQuestProgress();
                    this.showToast('Data refreshed', 'success');
                });
            }

            // Admin buttons
            const resetBtn = safeQuery('#resetAllPoints');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    this.resetAllPoints();
                });
            }

            const initBtn = safeQuery('#initializeData');
            if (initBtn) {
                initBtn.addEventListener('click', () => {
                    this.initializeSystemData();
                });
            }

            const exportBtn = safeQuery('#exportData');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    this.exportData();
                });
            }

            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        this.hideModal(modal.id);
                    }
                });
            });

            // Close modals on background click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.hideModal(modal.id);
                    }
                });
            });

            // Escape key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.hideModal('loginModal');
                    const groupModal = document.getElementById('groupModal');
                    if (groupModal) groupModal.remove();
                    this.teacherOverlay.hideOverlay();
                }
            });

            // Home page CTA buttons - enhanced for new pages
            document.querySelectorAll('[data-page]').forEach(btn => {
                if (btn.closest('.hero-actions-new') || 
                    btn.closest('.cta-actions') || 
                    btn.closest('.implementation-cta') ||
                    btn.closest('.cta-actions-final') ||
                    btn.closest('.rewards-cta-actions')) {
                    btn.addEventListener('click', (e) => {
                        const page = e.currentTarget.dataset.page;
                        this.switchPage(page);
                    });
                }
            });

            // How It Works button scroll
            const howItWorksBtn = document.querySelector('[onclick*="scrollToSection"]');
            if (howItWorksBtn) {
                howItWorksBtn.addEventListener('click', () => {
                    this.scrollToSection('how-it-works');
                });
            }

            console.log('‚úÖ Enhanced event listeners setup complete');
        } catch (error) {
            console.error('‚ùå Error setting up event listeners:', error);
        }
    }

    // ========== EXISTING FUNCTIONALITY (keep all existing methods) ==========
    
    // All existing methods like toggleTheme, setupWebGLBackground, setupParticleBackground,
    // showRewardAnimation, playConfetti, getData, saveData, loadInitialData, updateGroupsDisplay,
    // showGroupMembers, updateStudentPoints, applyGroupBonus, resetAllPoints, loadLeaderboardData,
    // switchTab, verifyAdminPassword, logout, hideLoadingScreen, etc. remain exactly the same.
    
    // Only the methods that need to integrate with new features are shown above.
    // All other existing methods from the previous script.js should be kept as they are.

    // ========== UTILITY METHODS ==========
    
    scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            section.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
    }

    toggleTheme() {
        this.currentTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', this.currentTheme);
        localStorage.setItem('jungleTheme', this.currentTheme);
        this.updateThemeIcon();
        this.showToast(`${this.currentTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è'} Theme switched to ${this.currentTheme}`, 'info');
    }

    updateThemeIcon() {
        const themeIcon = document.querySelector('#themeToggle i');
        if (themeIcon) {
            themeIcon.className = this.currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
    }

    switchClass(className) {
        this.currentClass = className;
        const classDisplay = document.getElementById('currentClassDisplay');
        if (classDisplay) {
            classDisplay.innerHTML = `<i class="fas fa-graduation-cap"></i> ${className}`;
        }
        
        this.loadInitialData();
    }

    switchView(view) {
        this.currentView = view;
        const viewButtons = document.querySelectorAll('.view-btn');
        
        viewButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.view === view) {
                btn.classList.add('active');
            }
        });

        if (view === 'teacher' && !this.isAuthenticated) {
            this.showModal('loginModal');
        } else {
            this.showToast(`Switched to ${view} view`, 'info');
        }
    }

    showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }

    showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas fa-${this.getToastIcon(type)}"></i>
            </div>
            <div class="toast-message">${message}</div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    getToastIcon(type) {
        const icons = {
            success: 'check-circle',
            error: 'exclamation-triangle',
            warning: 'exclamation-circle',
            info: 'info-circle'
        };
        return icons[type] || 'info-circle';
    }

    hideLoadingScreen() {
        console.log('üé¨ Hiding loading screen...');
        
        const loadingScreen = document.getElementById('loadingScreen');
        const appContainer = document.getElementById('app');
        
        if (loadingScreen && appContainer) {
            appContainer.classList.remove('hidden');
            
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transition = 'opacity 0.8s ease';
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                console.log('‚úÖ Loading screen hidden');
                
                this.showToast('Welcome to the Magical Jungle! üåø', 'success');
            }, 800);
        } else {
            console.error('‚ùå Could not find loading screen or app container');
            setTimeout(() => {
                if (appContainer) {
                    appContainer.classList.remove('hidden');
                }
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
            }, 2000);
        }
    }

    // ========== DATA MANAGEMENT (keep existing) ==========
    
    getData() {
        try {
            const storedData = localStorage.getItem(this.storageKey);
            if (storedData) {
                return JSON.parse(storedData);
            }
        } catch (error) {
            console.warn('LocalStorage read failed, using fallback data:', error);
        }
        
        return JSON.parse(JSON.stringify(COMPLETE_DATA));
    }

    saveData(data) {
        try {
            localStorage.setItem(this.storageKey, JSON.stringify(data));
            return true;
        } catch (error) {
            console.error('LocalStorage write failed:', error);
            this.showToast('Failed to save data. Changes may be lost on refresh.', 'error');
            return false;
        }
    }

    // ========== CLEANUP ==========
    
    cleanup() {
        if (this.animationFrameId) {
            cancelAnimationFrame(this.animationFrameId);
        }
    }
}

// ========== GLOBAL INITIALIZATION ==========

let appInstance = null;

document.addEventListener('DOMContentLoaded', () => {
    console.log('üåø DOM loaded - initializing Enhanced Jungle Rewards System');
    
    setTimeout(() => {
        try {
            appInstance = new JungleRewardsSystem();
            appInstance.initializeApp();
        } catch (error) {
            console.error('‚ùå Fatal error during app initialization:', error);
            const loadingScreen = document.getElementById('loadingScreen');
            const appContainer = document.getElementById('app');
            
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (appContainer) appContainer.classList.remove('hidden');
        }
    }, 100);
});

window.addEventListener('beforeunload', () => {
    if (appInstance) {
        appInstance.cleanup();
    }
});

// ========== GLOBAL UTILITY FUNCTIONS ==========

window.app = window.app || {};

window.switchPage = (page) => {
    if (window.appInstance) {
        window.appInstance.switchPage(page);
    }
};

window.switchView = (view) => {
    if (window.appInstance) {
        window.appInstance.switchView(view);
    }
};

window.scrollToSection = (sectionId) => {
    if (window.appInstance) {
        window.appInstance.scrollToSection(sectionId);
    }
};
